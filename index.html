<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Practice Pro - Multicanci√≥n ‚ú®</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.2.2/abcjs-basic-min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos base de la partitura */
        .abcjs-note { fill: #1e293b; transition: all 0.1s ease; }
        .abcjs-staff { stroke: #64748b; }
        
        /* Metr√≥nomo visual */
        .active-beat { background-color: #ef4444 !important; transform: scale(1.1); box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
        
        /* Resaltado de nota activa */
        .abcjs-highlight {
            fill: #ef4444 !important;
            stroke: #ef4444 !important;
            font-weight: bold;
        }

        /* Nombres de notas (letras inferiores - Cifrado) */
        .abcjs-lyric {
            fill: #64748b;
            font-size: 11px;
            font-weight: 600;
        }

        /* Digitaciones (N√∫meros 1-5) */
        .abcjs-fingering {
            fill: #4338ca;
            font-weight: bold;
            font-size: 11px;
            text-anchor: middle;
        }

        #paper svg { overflow: visible; width: 100%; height: auto; }
        
        /* Estilos de botones de estado */
        .btn-active { 
            background-color: #2563eb !important; 
            color: white !important; 
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4);
        }
        .btn-inactive { 
            background-color: #f1f5f9 !important; 
            color: #64748b !important; 
            border: 1px solid #e2e8f0 !important;
            box-shadow: none !important;
        }
        .btn-accent {
            background-color: #f59e0b !important;
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.4);
        }

        /* Leyenda Flotante */
        #note-legend {
            position: absolute; display: none; background: #1e1b4b; color: #ffffff;
            padding: 10px 18px; border-radius: 10px; font-size: 18px; font-weight: 900;
            pointer-events: none; z-index: 999999; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            transform: translate(-50%, -130%); border: 2px solid #ef4444; text-transform: uppercase;
        }
        #note-legend::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -8px;
            border-width: 8px; border-style: solid; border-color: #ef4444 transparent transparent transparent;
        }

        /* Selector personalizado */
        #song-selector {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8 font-sans text-slate-900">

    <div id="note-legend"></div>

    <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
        <!-- Header con Selector -->
        <div class="bg-slate-800 p-6 md:p-8 text-white flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 id="song-title" class="text-3xl font-bold tracking-tight text-center md:text-left">Cargando...</h1>
                <p id="song-subtitle" class="text-slate-300 opacity-80 italic text-center md:text-left">Pr√°ctica interactiva con ayudas visuales</p>
            </div>

            <div class="flex flex-col gap-1 w-full md:w-auto">
                <label class="text-[10px] font-bold uppercase tracking-widest text-slate-400 ml-1">Cambiar Obra</label>
                <select id="song-selector" class="bg-slate-700 text-white font-bold py-3 px-4 rounded-xl border border-slate-600 outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer transition-all">
                    <option value="minuet">Minueto en Sol (Bach/Petzold)</option>
                    <option value="scale_c">Escala de Do Mayor (T√©cnica)</option>
                    <option value="ode_joy">Oda a la Alegr√≠a (Beethoven)</option>
                    <option value="vals_1">Vals 1 (Alberto Mart√≠nez)</option>
                    <option value="brahms_lullaby">Canci√≥n de Cuna (J. Brahms)</option>
                    <option value="cancan">Can-Can (J. Offenbach)</option>
                    <option value="mariana">Mariana (Bastien)</option>
                    <option value="lavanda">Lavanda Azul (Bastien)</option>
                </select>
            </div>
        </div>

        <div class="p-6 md:p-10 space-y-6">
            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                <div class="flex flex-wrap items-center justify-between gap-6">
                    
                    <div class="flex flex-wrap gap-3">
                        <button id="play-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-md active:scale-95 flex items-center gap-2">
                            <span id="play-icon">‚ñ∂</span> <span id="play-text">O√çR PIANO</span>
                        </button>
                        
                        <button id="metro-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-md active:scale-95 flex items-center gap-2">
                            ‚åõ METR√ìNOMO
                        </button>

                        <button id="fingering-btn" class="btn-active px-5 py-3 rounded-xl font-bold transition-all shadow-sm active:scale-95 flex items-center gap-2 text-sm">
                            <span id="fingering-icon">üñêÔ∏è</span> <span id="fingering-text">DEDOS: ON</span>
                        </button>

                        <button id="cipher-btn" class="btn-active px-5 py-3 rounded-xl font-bold transition-all shadow-sm active:scale-95 flex items-center gap-2 text-sm">
                            <span id="cipher-icon">üî§</span> <span id="cipher-text">CIFRADO: LATINO</span>
                        </button>

                        <button id="stop-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-6 py-3 rounded-xl font-bold transition-all active:scale-95">
                            ‚èπ PARAR
                        </button>
                    </div>

                    <div class="flex flex-col items-center md:items-end">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Tempo</span>
                        <div class="flex items-center gap-4 bg-white p-2 rounded-2xl border border-slate-200 shadow-inner">
                            <button id="tempo-minus" class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-slate-400 hover:bg-slate-50 transition-colors">-10</button>
                            <span id="tempo-display" class="text-2xl font-mono font-bold text-slate-700 min-w-[80px] text-center">110</span>
                            <button id="tempo-plus" class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-slate-400 hover:bg-slate-50 transition-colors">+10</button>
                        </div>
                    </div>
                </div>

                <div id="beat-indicator-container" class="flex justify-center gap-6 py-2 border-t border-slate-200 pt-6 text-red-500"></div>
            </div>

            <div class="relative overflow-x-auto bg-white rounded-2xl border border-slate-100 p-8 shadow-inner text-center">
                <div id="paper" class="inline-block min-w-[700px] text-left"></div>
            </div>
        </div>
        
        <div class="bg-slate-50 p-4 text-center border-t border-slate-100 text-[10px] text-slate-400 font-bold uppercase tracking-widest">
            Pr√°ctica bimanual interactiva - Sistema de aprendizaje progresivo
        </div>
    </div>

    <script>
        const SONGS = {
            'minuet': {
                title: "Minueto en Sol Mayor",
                subtitle: "J.S. Bach / C. Petzold (Anhang 114)",
                tempo: 110,
                beatsPerBar: 3,
                abc: `
X:1
T:
M:3/4
L:1/8
Q:1/4=110
K:G
V:1 treble name="M.D."
V:2 bass name="M.I."
[V:1] !5!d2 !1!G!2!A !3!B!4!c | !5!d2 !1!G2 !1!G2 | !5!e2 !4!c!5!d !3!e!4!f | !5!g2 !1!G2 !1!G2 |
w: Re Sol La Si Do | Re Sol Sol | Mi Do Re Mi Fa# | Sol Sol Sol |
[V:2] !5!G,2 !3!B,2 !1!D2 | !5!G,4 !5!G,2 | !5!C2 !3!E2 !1!G2 | !5!C4 !5!C2 |
w: Sol Si Re | Sol Sol | Do Mi Sol | Do Do |`
            },
            'scale_c': {
                title: "Escala de Do Mayor",
                subtitle: "Calentamiento y t√©cnica fundamental",
                tempo: 80,
                beatsPerBar: 4,
                abc: `
X:1
T:
M:4/4
L:1/4
Q:1/4=80
K:C
V:1 treble name="M.D."
V:2 bass name="M.I."
[V:1] !1!C !2!D !3!E !1!F | !2!G !3!A !4!B !5!c | !5!c !4!B !3!A !2!G | !1!F !3!E !2!D !1!C |
w: Do Re Mi Fa | Sol La Si Do | Do Si La Sol | Fa Mi Re Do |
[V:2] !5!C, !4!D, !3!E, !2!F, | !1!G, !3!A, !2!B, !1!C | !1!C !2!B,, !3!A,, !1!G,, | !2!F,, !3!E,, !4!D,, !5!C,, |
w: Do Re Mi Fa | Sol La Si Do | Do Si La Sol | Fa Mi Re Do |`
            },
            'brahms_lullaby': {
                title: "Canci√≥n de Cuna",
                subtitle: "Johannes Brahms (Simplificado)",
                tempo: 80,
                beatsPerBar: 3,
                abc: `
X:1
T:
M:3/4
L:1/4
Q:1/4=80
K:C
V:1 treble name="M.D."
V:2 bass name="M.I."
[V:1] !3!E E !5!G | !3!E E !5!G | !3!E !5!G !5!c | !4!B2 !2!A |
w: Mi Mi Sol | Mi Mi Sol | Mi Sol Do | Si La |
[V:2] !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] |
w: Do Mi-Sol Mi-Sol | Do Mi-Sol Mi-Sol | Do Mi-Sol Mi-Sol | Sol Re-Fa Re-Fa |
[V:1] !2!D !3!E !4!F | !2!D !3!E !4!F | !2!D !4!F !4!B | !3!A2 !5!G |
w: Re Mi Fa | Re Mi Fa | Re Fa Si | La Sol |
[V:2] !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] | !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] | !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] | !5!C, [!3!E,!1!G,] [!3!E,!1!G,] |
w: Sol Re-Fa Re-Fa | Sol Re-Fa Re-Fa | Sol Re-Fa Re-Fa | Do Mi-Sol Mi-Sol |`
            },
            'cancan': {
                title: "Can-Can",
                subtitle: "Jacques Offenbach (Orfeo en los Infiernos)",
                tempo: 126,
                beatsPerBar: 4,
                abc: `
X:1
T:
M:4/4
L:1/4
Q:1/4=126
K:C
V:1 treble name="M.D."
V:2 bass name="M.I."
[V:1] !1!C !1!C !2!D !2!D | !3!E !3!E !4!F !4!F | !5!G !5!G !5!G !5!G | !3!E2 !1!C2 |
w: Do Do Re Re | Mi Mi Fa Fa | Sol Sol Sol Sol | Mi Do |
[V:2] !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, |
w: Do Sol Do Sol | Do Sol Do Sol | Do Sol Do Sol | Do Sol Do Sol |
[V:1] !2!D !2!D !3!E !3!E | !4!F !4!F !5!G !5!G | !2!D !3!E !4!F !2!D | !1!C2 z2 |
w: Re Re Mi Mi | Fa Fa Sol Sol | Re Mi Fa Re | Do |
[V:2] !1!G,, !4!D, !1!G,, !4!D, | !1!G,, !4!D, !1!G,, !4!D, | !1!G,, !4!D, !1!G,, !4!D, | !5!C,2 z2 |
w: Sol Re Sol Re | Sol Re Sol Re | Sol Re Sol Re | Do |`
            },
            'ode_joy': {
                title: "Oda a la Alegr√≠a",
                subtitle: "Ludwig van Beethoven (Novena Sinfon√≠a)",
                tempo: 120,
                beatsPerBar: 4,
                abc: `
X:1
T:
M:4/4
L:1/4
Q:1/4=120
K:G
V:1 treble name="M.D."
V:2 bass name="M.I."
[V:1] !3!B !3!B !4!c !5!d | !5!d !4!c !3!B !2!A | !1!G !1!G !2!A !3!B | !3!B>!2!A !2!A2 |
w: Si Si Do Re | Re Do Si La | Sol Sol La Si | Si La La |
[V:2] !1!G,2 !2!B,2 | !1!D2 !1!G,2 | !2!E,2 !3!C2 | !1!D,4 |
w: Sol Si | Re Sol | Mi Do | Re |`
            },
            'vals_1': {
                title: "Vals 1",
                subtitle: "Alberto Mart√≠nez - Nivel Principiante",
                tempo: 100,
                beatsPerBar: 3,
                abc: `
X:1
T:
M:3/4
L:1/4
Q:1/4=100
K:G
V:1 treble name="M.D."
V:2 bass name="M.I."
[V:1] !1!G !3!B !5!d | !5!d2 !5!d | !4!c !2!A !4!c | !3!B2 !1!G |
w: Sol Si Re | Re Re | Do La Do | Si Sol |
[V:2] !5!G,, [G,B,D] [G,B,D] | !5!G,, [G,B,D] [G,B,D] | !2!F,, [F,A,C] [F,A,C] | !5!G,, [G,B,D] [G,B,D] |
w: Sol Sol-Si-Re Sol-Si-Re | Sol Sol-Si-Re Sol-Si-Re | Fa Fa-La-Do Fa-La-Do | Sol Sol-Si-Re Sol-Si-Re |`
            },
            'mariana': {
                title: "Mariana",
                subtitle: "Bastien Adultos - Nivel 1",
                tempo: 100,
                beatsPerBar: 4,
                abc: `
X:1
T:
M:4/4
L:1/4
Q:1/4=100
K:C
V:1 treble name="M.D."
V:2 bass name="M.I."
[V:1] !3!E E !5!G G | !4!F F !3!E E | !2!D D !5!G G | !1!C4 |
w: Mi Mi Sol Sol | Fa Fa Mi Mi | Re Re Sol Sol | Do |
[V:2] [C,2E,2G,2] [C,2E,2G,2] | [C,2E,2G,2] [C,2E,2G,2] | [B,,2D,2G,2] [B,,2D,2G,2] | [C,4E,4G,4] |
w: Do-Mi-Sol | Do-Mi-Sol | Si-Re-Sol | Do-Mi-Sol |`
            },
            'lavanda': {
                title: "Lavanda Azul",
                subtitle: "Bastien Adultos - Nivel 1",
                tempo: 90,
                beatsPerBar: 3,
                abc: `
X:1
T:
M:3/4
L:1/4
Q:1/4=90
K:C
V:1 treble name="M.D."
V:2 bass name="M.I."
[V:1] !5!G G G | !5!G !4!F !3!E | !2!D !3!E !4!F | !3!E2 !1!C |
w: Sol Sol Sol | Sol Fa Mi | Re Mi Fa | Mi Do |
[V:2] !5!C,3 | !5!C,3 | !1!G,3 | !5!C,2 !5!C, |
w: Do | Do | Sol | Do Do |`
            }
        };

        const latToAng = { "Do": "C", "Re": "D", "Mi": "E", "Fa": "F", "Sol": "G", "La": "A", "Si": "B" };
        let currentSongId = 'minuet', tempo = 110, fingersActive = true, cipherMode = 'lat';
        let visualObj, synthControl, timingCallbacks, audioCtx = null, nextNoteTime = 0.0, currentBeat = 0, timerID = null;
        const noteNames = {
            "lat": ["Do", "Do#", "Re", "Re#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"],
            "ang": ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"]
        };

        window.onload = () => {
            loadSong('minuet');
            document.getElementById('song-selector').onchange = (e) => loadSong(e.target.value);
            document.getElementById('tempo-minus').onclick = () => updateTempo(-10);
            document.getElementById('tempo-plus').onclick = () => updateTempo(10);
            document.getElementById('fingering-btn').onclick = toggleFingers;
            document.getElementById('cipher-btn').onclick = toggleCipher;
            document.getElementById('play-btn').onclick = playPiano;
            document.getElementById('stop-btn').onclick = stopAll;
            document.getElementById('metro-btn').onclick = toggleMetro;
        };

        function loadSong(id) {
            stopAll();
            currentSongId = id;
            const song = SONGS[id];
            document.getElementById('song-title').innerText = song.title;
            document.getElementById('song-subtitle').innerText = song.subtitle;
            tempo = song.tempo;
            document.getElementById('tempo-display').innerText = tempo;
            const beatContainer = document.getElementById('beat-indicator-container');
            beatContainer.innerHTML = '';
            for(let i=0; i < song.beatsPerBar; i++) {
                const dot = document.createElement('div');
                dot.id = `beat-${i+1}`;
                dot.className = "w-5 h-5 rounded-full bg-slate-200 transition-all duration-100 shadow-inner";
                beatContainer.appendChild(dot);
            }
            renderScore();
        }

        function getProcessedAbc() {
            const song = SONGS[currentSongId];
            let abc = song.abc.replace(/Q:1\/4=\d+/, `Q:1/4=${tempo}`);
            if (!fingersActive) abc = abc.replace(/![1-5]!/g, "");
            if (cipherMode === 'off') {
                abc = abc.split('\n').filter(line => !line.trim().startsWith('w:')).join('\n');
            } else if (cipherMode === 'ang') {
                abc = abc.split('\n').map(line => {
                    if (line.trim().startsWith('w:')) {
                        let content = line.substring(2);
                        Object.keys(latToAng).forEach(lat => {
                            const regex = new RegExp(lat + '(?![a-z])', 'g');
                            content = content.replace(regex, latToAng[lat]);
                        });
                        return 'w:' + content;
                    }
                    return line;
                }).join('\n');
            }
            return abc;
        }

        function renderScore() {
            visualObj = ABCJS.renderAbc("paper", getProcessedAbc(), {
                responsive: 'resize', add_classes: true, staffwidth: 740, scale: 1.1,
                clickListener: (abcElem, tuneNumber, classes, analysis, event) => {
                    const legend = document.getElementById('note-legend');
                    if (abcElem && abcElem.el_type === "note") {
                        const pitch = abcElem.pitches[0].pitch;
                        const mode = (cipherMode === 'ang') ? 'ang' : 'lat';
                        legend.innerText = noteNames[mode][pitch % 12];
                        legend.style.display = 'block';
                        legend.style.left = (event.pageX) + 'px';
                        legend.style.top = (event.pageY - 60) + 'px';
                        setTimeout(() => legend.style.display = 'none', 1500);
                    }
                }
            })[0];
        }

        function toggleFingers() {
            fingersActive = !fingersActive;
            this.className = fingersActive ? "btn-active px-5 py-3 rounded-xl font-bold transition-all shadow-sm active:scale-95 flex items-center gap-2 text-sm" : "btn-inactive px-5 py-3 rounded-xl font-bold transition-all shadow-sm active:scale-95 flex items-center gap-2 text-sm";
            document.getElementById('fingering-text').innerText = fingersActive ? "DEDOS: ON" : "DEDOS: OFF";
            document.getElementById('fingering-icon').innerText = fingersActive ? "üñêÔ∏è" : "üö´";
            renderScore();
        }

        function toggleCipher() {
            if (cipherMode === 'lat') cipherMode = 'ang';
            else if (cipherMode === 'ang') cipherMode = 'off';
            else cipherMode = 'lat';
            this.className = (cipherMode === 'lat') ? "btn-active px-5 py-3 rounded-xl font-bold transition-all shadow-sm active:scale-95 flex items-center gap-2 text-sm" : 
                             (cipherMode === 'ang') ? "btn-accent px-5 py-3 rounded-xl font-bold transition-all shadow-sm active:scale-95 flex items-center gap-2 text-sm" : 
                             "btn-inactive px-5 py-3 rounded-xl font-bold transition-all shadow-sm active:scale-95 flex items-center gap-2 text-sm";
            document.getElementById('cipher-text').innerText = (cipherMode === 'lat') ? "CIFRADO: LATINO" : (cipherMode === 'ang') ? "CIFRADO: ANGLO" : "CIFRADO: OFF";
            document.getElementById('cipher-icon').innerText = (cipherMode === 'lat') ? "üî§" : (cipherMode === 'ang') ? "üá∫üá∏" : "üö´";
            renderScore();
        }

        function updateTempo(v) {
            tempo = Math.max(40, Math.min(220, tempo + v));
            document.getElementById('tempo-display').innerText = tempo;
            stopAll();
            renderScore();
        }

        function stopAll() {
            if (synthControl) { synthControl.synth.stop(); synthControl = null; }
            if (timingCallbacks) { timingCallbacks.stop(); timingCallbacks = null; }
            if (timerID) clearTimeout(timerID);
            document.querySelectorAll('.abcjs-highlight').forEach(el => el.classList.remove('abcjs-highlight'));
            document.querySelectorAll('[id^="beat-"]').forEach(b => b.classList.remove('active-beat'));
            isPlaying = false; isMetroRunning = false;
            document.getElementById('play-text').innerText = "O√çR PIANO";
            document.getElementById('metro-btn').innerHTML = "‚åõ METR√ìNOMO";
        }

        function toggleMetro() {
            if (isMetroRunning) { stopAll(); } else {
                initAudio();
                stopAll();
                isMetroRunning = true; currentBeat = 0; nextNoteTime = audioCtx.currentTime;
                timingCallbacks = new ABCJS.TimingCallbacks(visualObj, { qpm: tempo, eventCallback: eventCallback });
                timingCallbacks.start();
                scheduler();
                this.innerText = "‚èπ PARAR";
            }
        }

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        async function playPiano() {
            if (isPlaying) { stopAll(); return; }
            stopAll(); initAudio();
            if (ABCJS.synth.supportsAudio()) {
                const synth = new ABCJS.synth.CreateSynth();
                const audioObj = ABCJS.renderAbc("paper", getProcessedAbc(), { responsive: 'resize', add_classes: true, staffwidth: 740 })[0];
                timingCallbacks = new ABCJS.TimingCallbacks(audioObj, { 
                    qpm: tempo, eventCallback: eventCallback,
                    beatCallback: (b) => {
                        const song = SONGS[currentSongId];
                        const n = (b % song.beatsPerBar) + 1;
                        document.querySelectorAll('[id^="beat-"]').forEach(el => el.classList.remove('active-beat'));
                        const dot = document.getElementById(`beat-${n}`);
                        if (dot) dot.classList.add('active-beat');
                    }
                });
                await synth.init({ visualObj: audioObj, options: { soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/" } });
                await synth.prime();
                timingCallbacks.start();
                synth.start();
                synthControl = { synth }; isPlaying = true;
                document.getElementById('play-text').innerText = "PAUSAR";
            }
        }

        function scheduler() {
            const song = SONGS[currentSongId];
            while (nextNoteTime < audioCtx.currentTime + 0.1) {
                playClick(nextNoteTime, currentBeat % song.beatsPerBar === 0);
                const n = (currentBeat % song.beatsPerBar) + 1;
                setTimeout(() => {
                    document.querySelectorAll('[id^="beat-"]').forEach(b => b.classList.remove('active-beat'));
                    const dot = document.getElementById(`beat-${n}`);
                    if (dot) dot.classList.add('active-beat');
                }, (nextNoteTime - audioCtx.currentTime) * 1000);
                nextNoteTime += (60.0 / tempo);
                currentBeat++;
            }
            timerID = setTimeout(scheduler, 25);
        }

        function playClick(time, isFirst) {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.frequency.setValueAtTime(isFirst ? 1000 : 700, time);
            g.gain.setValueAtTime(0.3, time);
            g.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(time); osc.stop(time + 0.1);
        }

        function eventCallback(ev) {
            document.querySelectorAll('.abcjs-highlight').forEach(el => el.classList.remove('abcjs-highlight'));
            if (ev && ev.elements) {
                ev.elements.forEach(g => g.forEach(el => {
                    el.classList.add('abcjs-highlight');
                    const nid = Array.from(el.classList).find(c => c.startsWith('abcjs-n'));
                    if (nid) document.querySelectorAll(`.${nid}.abcjs-lyric`).forEach(l => l.classList.add('abcjs-highlight'));
                }));
            }
        }
    </script>
</body>
</html>
