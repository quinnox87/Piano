<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PianoClass: Lumina Edition</title>
    <!-- ABCjs para partituras -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.2.2/abcjs-basic-min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        lumina: {
                            bg: '#F8FAFC',
                            panel: '#FFFFFF',
                            border: '#E2E8F0',
                            text: '#334155',
                            secondary: '#64748B',
                            accent: '#818CF8',
                            success: '#34D399',
                            danger: '#F87171',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8FAFC;
            color: #334155;
            transition: background-color 0.5s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .elegant-card {
            background: #FFFFFF;
            border: 1px solid #E2E8F0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .elegant-card { border-radius: 1.25rem; }
        }

        /* ESTILOS ABCJS */
        .abcjs-note { fill: #0F172A !important; transition: fill 0.1s ease; }
        .abcjs-staff { stroke: #475569 !important; stroke-width: 1.2; }
        
        /* Resaltado de notas (SVG path) */
        .abcjs-highlight { 
            fill: #EF4444 !important; 
            stroke: #EF4444 !important; 
            filter: drop-shadow(0px 0px 4px rgba(239, 68, 68, 0.6)); 
        }
        
        /* Resaltado espec√≠fico para letras (texto) para evitar stroke sucio */
        .lyric-highlight { 
            fill: #4F46E5 !important; 
            font-weight: 800;
            text-shadow: 0px 0px 1px rgba(79, 70, 229, 0.5);
        }
        
        .abcjs-lyric { fill: #64748B; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 600; }
        .abcjs-fingering { fill: #EF4444; font-weight: 800; font-size: 10px; }

        #paper { background: #FFFFFF; width: 100%; border-radius: 0.75rem; }
        #paper svg { width: 100%; height: auto; display: block; margin: 0 auto; }

        /* CORRECCI√ìN CSS .btn-lumina */
        .btn-lumina {
            display: inline-flex;
            align-items: center; /* Corregido items-center */
            justify-content: center;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.02em;
            cursor: pointer;
            user-select: none;
        }

        .btn-primary { background: linear-gradient(135deg, #818CF8, #6366F1); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }
        .btn-ghost { background-color: #F1F5F9; color: #475569; border: 1px solid #E2E8F0; }
        .btn-stop { background-color: #FEE2E2; color: #EF4444; border: 1px solid #FCA5A5; }

        /* Opciones de Generaci√≥n IA */
        .ai-option-btn {
            background-color: #FFFFFF; border: 1px solid #E2E8F0; color: #64748B;
            padding: 0.75rem 0.5rem; border-radius: 0.75rem; font-size: 0.75rem; font-weight: 600;
            transition: all 0.2s; text-align: center;
        }
        .ai-option-btn.selected { background-color: #EEF2FF; color: #4F46E5; border-color: #6366F1; }

        /* Visualizaci√≥n del Metr√≥nomo */
        .beat-dot { transition: all 0.15s; background-color: #E2E8F0; width: 10px; height: 10px; border-radius: 50%; }
        .beat-active { background-color: #EF4444 !important; box-shadow: 0 0 10px rgba(239, 68, 68, 0.6); transform: scale(1.2); }

        #notification-box {
            position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
            padding: 0.75rem 1.5rem; border-radius: 0.75rem; background: #1E293B; color: white;
            z-index: 100; display: none; width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        #note-tooltip {
            position: absolute; display: none; background: #1E293B; color: white;
            padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;
            pointer-events: none; z-index: 50; transform: translate(-50%, -150%);
        }
    </style>
</head>
<body class="antialiased min-h-screen pb-6 md:pb-12">

    <div id="note-tooltip">Nota</div>
    <div id="notification-box"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8 w-full">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 md:mb-10 border-b border-slate-200 pb-6 md:pb-8 gap-4">
            <div class="text-center md:text-left w-full md:w-auto">
                <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">
                    Piano<span class="text-indigo-500">Class</span>
                </h1>
                <p class="text-slate-500 font-medium text-sm md:text-base mt-0.5">Lumina: Sesi√≥n de Larga Duraci√≥n</p>
            </div>
            
            <div class="flex items-center justify-center md:justify-end gap-2 md:gap-4 w-full md:w-auto">
                <div class="bg-indigo-50 border border-indigo-100 px-3 md:px-5 py-2 rounded-xl shadow-sm flex items-center gap-2 md:gap-3">
                    <div class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-indigo-500 animate-pulse"></div>
                    <span class="text-[10px] md:text-xs font-bold text-indigo-700 uppercase tracking-widest">Resistencia Cognitiva</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
            
            <div class="lg:col-span-3 space-y-4 md:space-y-6">
                
                <div class="elegant-card p-4 md:p-6">
                    <label class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 md:mb-4 block">Repertorio Maestro</label>
                    <select id="song-selector" class="w-full bg-slate-50 text-slate-700 text-xs md:text-sm font-semibold py-2.5 px-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-200 transition-all cursor-pointer">
                        <option value="minuet">Minueto en Sol (Bach) - Completo</option>
                        <option value="preludio_bach">Preludio en Do (Bach BWV 846)</option>
                        <option value="comptine">Comptine d'un autre √©t√© (Tiersen)</option>
                        <option value="scale_c">Escala Do Mayor - 2 Octavas</option>
                        <option value="ode_joy">Oda a la Alegr√≠a - Beethoven</option>
                    </select>
                    <div id="song-meta" class="mt-3 text-[10px] text-slate-400 italic">Bach / Barroco</div>
                </div>

                <div class="elegant-card p-4 md:p-6">
                    <h3 class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Controles</h3>
                    <div class="space-y-3">
                        <button id="play-btn" class="btn-lumina btn-primary w-full text-white text-xs md:text-sm">‚ñ∂ Iniciar Pr√°ctica</button>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="stop-btn" class="btn-lumina btn-stop text-[10px]">‚èπ Parar</button>
                            <button id="metro-btn" class="btn-lumina btn-ghost text-[10px]">‚åõ Metr.</button>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-100">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase">Tempo (BPM)</span>
                            <span id="tempo-display" class="text-lg md:text-xl font-bold text-indigo-600">110</span>
                        </div>
                        <input type="range" id="tempo-slider" min="40" max="200" value="110" step="10" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <div class="elegant-card p-4 md:p-6">
                    <h3 class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Asistentes</h3>
                    <div class="space-y-3">
                        <button id="fingering-btn" class="w-full btn-lumina btn-ghost justify-between">
                            <span class="text-slate-600">Digitaci√≥n</span>
                            <span id="fingering-status" class="bg-indigo-100 text-indigo-600 px-2.5 py-0.5 rounded-full text-[9px] font-bold">ON</span>
                        </button>
                        <button id="cipher-btn" class="w-full btn-lumina btn-ghost justify-between">
                            <span class="text-slate-600">Cifrado</span>
                            <span id="cipher-status" class="bg-slate-200 text-slate-500 px-2.5 py-0.5 rounded-full text-[9px] font-bold">LAT</span>
                        </button>
                    </div>
                </div>

                <div class="elegant-card p-4 border-dashed border-indigo-200 bg-indigo-50/30">
                    <button onclick="toggleAiGenerator()" class="w-full flex flex-col items-center gap-2 group transition-all">
                        <span class="text-2xl filter drop-shadow-sm group-hover:scale-110 transition-transform">‚ú®</span>
                        <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest text-center">Generar Obra IA</span>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-9">
                <div id="main-paper-container" class="elegant-card p-0 flex flex-col min-h-[500px] md:min-h-[800px] overflow-hidden relative">
                    
                    <div class="px-4 md:px-8 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <div class="flex gap-2 md:gap-4" id="beat-container"></div>
                        <div class="text-[8px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1 md:gap-2">
                            <span class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-emerald-400"></span> 
                            <span>Motor: Gemini 2.5 Flash</span>
                            <span id="api-status-dot" class="w-1.5 h-1.5 rounded-full bg-slate-300 ml-1" title="Estado API"></span>
                        </div>
                    </div>

                    <!-- MODAL COMPOSITOR IA -->
                    <div id="ai-generator-overlay" class="fixed inset-0 z-[60] bg-white/95 p-6 md:p-12 hidden animate-fade-in flex flex-col">
                        <div class="flex justify-between items-start mb-6 md:mb-12">
                            <div>
                                <h3 class="text-xl md:text-3xl font-bold text-slate-900">Compositor Maestro ‚ú®</h3>
                                <p class="text-xs md:text-sm text-slate-500 mt-0.5">Composici√≥n inteligente basada en tu disciplina.</p>
                            </div>
                            <button onclick="toggleAiGenerator()" class="text-slate-400 hover:text-slate-900 text-2xl md:text-3xl p-2 transition-colors">‚úï</button>
                        </div>
                        
                        <!-- API Key Input Seguro -->
                        <div class="mb-8 p-4 bg-slate-50 rounded-xl border border-slate-200">
                             <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Configuraci√≥n API (Guardada localmente)</label>
                             <div class="flex gap-2">
                                 <input type="password" id="api-key-input" placeholder="Pega tu API Key de Google AI Studio aqu√≠..." class="flex-grow text-xs bg-white border border-slate-200 rounded-lg px-3 py-2 outline-none focus:border-indigo-500 font-mono">
                                 <button onclick="saveApiKey()" class="btn-lumina btn-ghost text-[10px] whitespace-nowrap">üíæ Guardar</button>
                             </div>
                        </div>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 md:gap-6 mb-8 overflow-y-auto pr-2">
                            <button onclick="selectAiOption('Cl√°sica', this)" class="ai-option-btn">üéπ Cl√°sica</button>
                            <button onclick="selectAiOption('Moderna', this)" class="ai-option-btn">üé∏ Moderna</button>
                            <button onclick="selectAiOption('Mano Derecha', this)" class="ai-option-btn">‚úã Der.</button>
                            <button onclick="selectAiOption('Mano Izquierda', this)" class="ai-option-btn">ü§ö Izq.</button>
                            <button onclick="selectAiOption('Acordes', this)" class="ai-option-btn">üéº Acordes</button>
                            <button onclick="selectAiOption('Escalas', this)" class="ai-option-btn">üìè Escalas</button>
                            <button onclick="selectAiOption('Calentamiento', this)" class="ai-option-btn">‚òï Calentar</button>
                            <button onclick="selectAiOption('Cognitivo', this)" class="ai-option-btn">üß† Cognitivo</button>
                        </div>

                        <div class="mt-auto flex flex-col items-center gap-4">
                            <button id="main-gen-btn" onclick="generateExercise()" class="btn-lumina btn-primary text-white w-full md:min-w-[320px] opacity-50 cursor-not-allowed py-4 md:py-5 text-base md:text-lg rounded-2xl" disabled>
                                <span id="gen-btn-text">Generar Obra con Gemini</span>
                                <span id="gen-btn-loader" class="hidden animate-spin text-xl">‚ü≥</span>
                            </button>
                        </div>
                    </div>

                    <div class="flex-grow p-4 md:p-12 overflow-x-auto flex flex-col items-center bg-white relative">
                        <div id="paper-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10 hidden">
                             <div class="flex flex-col items-center gap-3">
                                <div class="animate-spin rounded-full h-10 w-10 md:h-16 md:w-16 border-t-4 border-indigo-500 border-r-transparent"></div>
                                <span class="text-indigo-600 font-bold text-[10px] uppercase tracking-widest">Creando partitura...</span>
                             </div>
                        </div>
                        <div id="paper" class="w-full max-w-4xl"></div>
                    </div>

                    <div class="px-4 md:px-8 py-3 border-t border-slate-100 bg-slate-50/50 flex justify-between items-center text-[8px] md:text-[11px] font-bold text-slate-400 uppercase tracking-widest">
                        <div class="flex space-x-4 md:space-x-12">
                            <div>Comp√°s: <span id="time-sig" class="text-indigo-600 ml-1">--</span></div>
                            <div>Tono: <span id="key-sig" class="text-indigo-600 ml-1">--</span></div>
                        </div>
                        <div class="flex items-center gap-1 opacity-60">
                            <span class="text-indigo-400">‚ö°</span> <span>Long-Play Engine v3.1 (Stable)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // VARIABLE GLOBAL (se carga desde localStorage)
        let apiKey = ""; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025"; // Modelo definido constante

        const SONGS = {
            'minuet': { 
                title: "Minueto en Sol (Bach)", 
                subtitle: "Bach / Barroco - Estructura Completa", 
                tempo: 110, beats: 3, key: "G", time: "3/4", 
                abc: `X:1\nM:3/4\nL:1/8\nQ:1/4=110\nK:G\nV:1 treble\nV:2 bass\n[V:1] !5!d2 !1!G!2!A !3!B!4!c | !5!d2 !1!G2 !1!G2 | !5!e2 !4!c!5!d !3!e!4!f | !5!g2 !1!G2 !1!G2 |\nw: Re Sol La Si Do | Re Sol Sol | Mi Do Re Mi Fa# | Sol Sol Sol |\n[V:1] !4!c2 !5!d!4!c !3!B!2!A | !3!B2 !4!c!3!B !2!A!1!G | !1!F!2!G !3!A!2!B !3!A!1!G | !2!A6 |\nw: Do Re Do Si La | Si Do Si La Sol | Fa# Sol La Si La Sol | La |\n[V:2] !5!G,2 !3!B,2 !1!D2 | !5!G,4 !5!G,2 | !5!C2 !3!E2 !1!G2 | !5!C4 !5!C2 |\nw: Sol Si Re | Sol Sol | Do Mi Sol | Do Do |\n[V:2] !3!E,4 !3!E,2 | !5!G,4 !5!G,2 | !1!D,4 !1!D,2 | !1!D,6 |\nw: Mi Mi | Sol Sol | Re Re | Re |` 
            },
            'comptine': {
                title: "Comptine d'un autre √©t√©",
                subtitle: "Yann Tiersen - Beginner Version",
                tempo: 80, beats: 4, key: "Em", time: "4/4",
                abc: `X:1\nM:4/4\nL:1/8\nQ:1/4=80\nK:Em\nV:1 treble\nV:2 bass\n[V:1] !1!E2 !2!G2 !3!B2 !5!e2 | !3!B2 !2!G2 !1!E4 | !1!G2 !2!B2 !3!d2 !5!g2 | !3!d2 !2!B2 !1!G4 |\nw: Mi Sol Si Mi | Si Sol Mi | Sol Si Re Sol | Re Si Sol |\n[V:1] !1!D2 !2!F2 !3!A2 !5!d2 | !3!A2 !2!F2 !1!D4 | !1!E2 !2!A2 !3!c2 !5!e2 | !3!c2 !2!A2 !1!E4 |\nw: Re Fa# La Re | La Fa# Re | Mi La Do Mi | Do La Mi |\n[V:2] !5!E,2 !2!B,2 !1!E2 !2!B,2 | !5!E,2 !2!B,2 !1!E2 !2!B,2 | !5!G,,2 !2!D,2 !1!G,2 !2!D,2 | !5!G,,2 !2!D,2 !1!G,2 !2!D,2 |\nw: Mi Si Mi Si | Mi Si Mi Si | Sol Re Sol Re | Sol Re Sol Re |\n[V:2] !5!D,,2 !2!A,,2 !1!D,2 !2!A,,2 | !5!D,,2 !2!A,,2 !1!D,2 !2!A,,2 | !5!A,,2 !2!E,2 !1!A,2 !2!E,2 | !5!A,,2 !2!E,2 !1!A,2 !2!E,2 |\nw: Re La Re La | Re La Re La | La Mi La Mi | La Mi La Mi |`
            },
            'preludio_bach': {
                title: "Preludio en Do Mayor (BWV 846)",
                subtitle: "J.S. Bach - El Clave Bien Temperado",
                tempo: 70, beats: 4, key: "C", time: "4/4",
                abc: `X:1\nM:4/4\nL:1/8\nQ:1/4=70\nK:C\nV:1 treble\nV:2 bass\n[V:1] z !2!E!3!G!5!c !2!E!3!G!5!c | z !2!E!3!G!5!c !2!E!3!G!5!c | z !2!D!3!F!5!B !2!D!3!F!5!B | z !2!D!3!F!5!B !2!D!3!F!5!B |\nw: Mi Sol Do Mi Sol Do | Mi Sol Do Mi Sol Do | Re Fa Si Re Fa Si | Re Fa Si Re Fa Si |\n[V:1] z !2!D!3!G!5!c !2!D!3!G!5!c | z !2!D!3!G!5!c !2!D!3!G!5!c | z !2!E!3!G!5!c !2!E!3!G!5!c | z !2!E!3!G!5!c !2!E!3!G!5!c |\nw: Re Sol Do Re Sol Do | Re Sol Do Re Sol Do | Mi Sol Do Mi Sol Do | Mi Sol Do Mi Sol Do |\n[V:2] !5!C,2 !1!G,4 z2 | !5!C,2 !1!G,4 z2 | !5!C,2 !1!A,4 z2 | !5!C,2 !1!A,4 z2 |\nw: Do Sol | Do Sol | Do La | Do La |\n[V:2] !5!B,,2 !1!G,4 z2 | !5!B,,2 !1!G,4 z2 | !5!C,2 !1!G,4 z2 | !5!C,2 !1!G,4 z2 |\nw: Si Sol | Si Sol | Do Sol | Do Sol |`
            },
            'scale_c': { 
                title: "Escala Do Mayor", 
                subtitle: "T√©cnica - 2 Octavas", 
                tempo: 80, beats: 4, key: "C", time: "4/4", 
                abc: `X:1\nM:4/4\nL:1/4\nQ:1/4=80\nK:C\nV:1 treble\n[V:1] !1!C !2!D !3!E !1!F | !2!G !3!A !4!B !5!c | !1!c !2!d !3!e !1!f | !2!g !3!a !4!b !5!c' |\nw: Do Re Mi Fa | Sol La Si Do | Do Re Mi Fa | Sol La Si Do |` 
            },
            'ode_joy': { 
                title: "Oda a la Alegr√≠a", 
                subtitle: "Beethoven - Melod√≠a Principal", 
                tempo: 120, beats: 4, key: "G", time: "4/4", 
                abc: `X:1\nM:4/4\nL:1/4\nQ:1/4=120\nK:G\nV:1 treble\n[V:1] !3!B !3!B !4!c !5!d | !5!d !4!c !3!B !2!A | !1!G !1!G !2!A !3!B | !3!B>!2!A !2!A2 |\nw: Si Si Do Re | Re Do Si La | Sol Sol La Si | Si La La |` 
            }
        };

        const noteNamesMap = { "Do": "C", "Re": "D", "Mi": "E", "Fa": "F", "Sol": "G", "La": "A", "Si": "B" };

        let state = { songId: 'minuet', tempo: 110, fingers: true, cipher: 'lat', isPlaying: false, isMetro: false, audioCtx: null, generatedSong: null, currentOption: null };
        let abcInstance, synthControl, timingCallbacks, metronomeTimer;

        document.addEventListener('DOMContentLoaded', () => {
            // Cargar API Key
            apiKey = localStorage.getItem('pianoclass_gemini_key') || "";
            if(apiKey) {
                document.getElementById('api-status-dot').classList.replace('bg-slate-300', 'bg-emerald-400');
                document.getElementById('api-key-input').value = apiKey;
            }

            loadSong('minuet');
            setupListeners();
        });

        function saveApiKey() {
            const input = document.getElementById('api-key-input').value.trim();
            if(input) {
                apiKey = input;
                localStorage.setItem('pianoclass_gemini_key', apiKey);
                document.getElementById('api-status-dot').classList.replace('bg-slate-300', 'bg-emerald-400');
                showNotification("API Key guardada correctamente");
            } else {
                showNotification("La API Key no puede estar vac√≠a");
            }
        }

        function setupListeners() {
            document.getElementById('song-selector').addEventListener('change', (e) => loadSong(e.target.value));
            document.getElementById('fingering-btn').addEventListener('click', toggleFingers);
            document.getElementById('cipher-btn').addEventListener('click', toggleCipher);
            document.getElementById('play-btn').addEventListener('click', playPiano);
            document.getElementById('stop-btn').addEventListener('click', stopAll);
            document.getElementById('metro-btn').addEventListener('click', toggleMetro);
            document.getElementById('tempo-slider').addEventListener('input', (e) => updateTempo(0, parseInt(e.target.value)));
            window.addEventListener('resize', debounce(() => renderScore(), 250));
        }

        function debounce(func, wait) {
            let timeout;
            return function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, arguments), wait);
            };
        }

        // --- L√ìGICA CENTRALIZADA ABC ---
        function getEffectiveAbc(song){
          let abc = song.abc;

          // Tempo: Forzar tempo actual
          if (abc.includes('Q:')) abc = abc.replace(/Q:1\/4=\d+/, `Q:1/4=${state.tempo}`);
          else abc = abc.replace('K:', `Q:1/4=${state.tempo}\nK:`);

          // Digitaci√≥n
          if(!state.fingers) abc = abc.replace(/![1-5]!/g, "");

          // Cifrado y Letras (w:)
          if(state.cipher === 'off') {
            // Elimina l√≠neas que empiezan por w:
            abc = abc.split('\n').filter(l => !l.trim().startsWith('w:')).join('\n');
          } else if (state.cipher === 'ang') {
            // Convierte latino a anglosaj√≥n
            abc = abc.split('\n').map(line => {
              if (line.trim().startsWith('w:')) {
                let content = line.replace(/^\s*w:\s*/, '');
                const sortedKeys = Object.keys(noteNamesMap).sort((a,b) => b.length - a.length);
                sortedKeys.forEach(k => {
                  const regex = new RegExp(k + '(?![a-z])', 'g');
                  content = content.replace(regex, noteNamesMap[k]);
                });
                return 'w: ' + content;
              }
              return line;
            }).join('\n');
          }
          // Si es 'lat', dejamos el original (asumiendo que viene en latino)
          return abc;
        }

        function pitchToNoteName(pitch, lang='lat'){
            if (pitch === undefined || pitch === null) return "";
            const namesAng = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
            const namesLat = ["Do","Do#","Re","Re#","Mi","Fa","Fa#","Sol","Sol#","La","La#","Si"];
            // C√°lculo de √≠ndice de nota (0-11) y octava
            const noteIndex = ((pitch % 12) + 12) % 12;
            const octave = Math.floor(pitch / 12) - 1; 
            
            const noteName = (lang === 'ang') ? namesAng[noteIndex] : namesLat[noteIndex];
            return `${noteName}${octave}`;
        }

        function toggleAiGenerator() { document.getElementById('ai-generator-overlay').classList.toggle('hidden'); }

        function selectAiOption(option, element) {
            state.currentOption = option;
            document.querySelectorAll('.ai-option-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            const genBtn = document.getElementById('main-gen-btn');
            genBtn.disabled = false; genBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        async function callGemini(promptText) {
            if (!apiKey) {
                showNotification("Error: Configura tu API Key primero (icono üíæ)");
                return null;
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
            
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) {
                    if (i === 4) {
                        showNotification("Error IA: " + error.message);
                        return null;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }

        async function generateExercise() {
            if (!state.currentOption) return;
            const btn = document.getElementById('main-gen-btn'), loader = document.getElementById('gen-btn-loader'), 
                  text = document.getElementById('gen-btn-text'), paperLoading = document.getElementById('paper-loading');
            btn.disabled = true; loader.classList.remove('hidden'); text.classList.add('hidden'); paperLoading.classList.remove('hidden');

            const prompt = `Genera un ejercicio de piano (8 compases) en formato ABC basado en: "${state.currentOption}".
REGLAS: X:1, T:Composici√≥n IA, M:4/4, L:1/4, K:C. Notas con digitaci√≥n !1!-!5!. Incluye l√≠nea 'w:' con nombres Do, Re, Mi... 
Devuelve solo el c√≥digo ABC limpio.`;

            let abcCode = await callGemini(prompt);
            if (abcCode) {
                abcCode = abcCode.replace(/```[a-z]*\n?/gi, '').replace(/```/g, '').trim();
                state.generatedSong = { title: "Composici√≥n IA", subtitle: `Estilo: ${state.currentOption}`, tempo: 100, beats: 4, key: "C", time: "4/4", abc: abcCode };
                loadSong('generated');
                toggleAiGenerator();
                showNotification("¬°Obra generada con √©xito!");
            }
            btn.disabled = false; loader.classList.add('hidden'); text.classList.remove('hidden'); paperLoading.classList.add('hidden');
        }

        function loadSong(id) {
            stopAll();
            let song = (id === 'generated' && state.generatedSong) ? state.generatedSong : (SONGS[id] || SONGS['minuet']);
            state.songId = id;
            document.getElementById('song-meta').innerText = song.subtitle || "";
            updateTempo(0, song.tempo);
            document.getElementById('time-sig').innerText = song.time;
            document.getElementById('key-sig').innerText = song.key;
            const beatContainer = document.getElementById('beat-container');
            beatContainer.innerHTML = '';
            for(let i=0; i<(song.beats || 4); i++) {
                const dot = document.createElement('div');
                dot.className = `beat-dot`;
                dot.id = `beat-${i+1}`;
                beatContainer.appendChild(dot);
            }
            renderScore();
        }

        function renderScore() {
            let song = state.songId === 'generated' ? state.generatedSong : SONGS[state.songId];
            // Usamos la l√≥gica centralizada
            let abc = getEffectiveAbc(song);

            abcInstance = ABCJS.renderAbc("paper", abc, {
                responsive: 'resize', add_classes: true, staffwidth: 800, scale: 1.1,
                // Click listener corregido usando el evento pasado por ABCjs
                clickListener: (abcElem, tuneNumber, classes, analysis, drag, mouseEvent) => {
                  if (abcElem && abcElem.el_type === "note") showTooltip(mouseEvent, abcElem.pitches?.[0]?.pitch);
                }
            })[0];
        }

        function updateTempo(delta, exact = null) {
            state.tempo = exact ? exact : Math.max(40, Math.min(200, state.tempo + delta));
            document.getElementById('tempo-display').innerText = state.tempo;
            document.getElementById('tempo-slider').value = state.tempo;
            if(state.isPlaying || state.isMetro) stopAll();
            else renderScore();
        }

        function initAudio() {
            if (!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (state.audioCtx.state === 'suspended') state.audioCtx.resume();
        }

        async function playPiano() {
            if (state.isPlaying) { stopAll(); return; }
            
            // Gesti√≥n de conflicto con Metr√≥nomo
            if(state.isMetro) {
                stopAll();
                showNotification("Metr√≥nomo detenido. Iniciando reproducci√≥n.");
                // Peque√±a pausa para evitar solapamiento de audio
                await new Promise(r => setTimeout(r, 100));
            }

            initAudio(); state.isPlaying = true;
            document.getElementById('play-btn').innerHTML = '<span>‚è∏ Pausar</span>';

            if (ABCJS.synth.supportsAudio()) {
                const synth = new ABCJS.synth.CreateSynth();
                let song = state.songId === 'generated' ? state.generatedSong : SONGS[state.songId];
                
                // CR√çTICO: Usar el mismo ABC procesado que se ve en pantalla
                const effectiveAbc = getEffectiveAbc(song);

                const audioObj = ABCJS.renderAbc("paper", effectiveAbc, { responsive: 'resize' })[0];
                timingCallbacks = new ABCJS.TimingCallbacks(audioObj, {
                    qpm: state.tempo,
                    eventCallback: (ev) => {
                        // Limpiar highlights previos
                        document.querySelectorAll('.abcjs-highlight').forEach(el => el.classList.remove('abcjs-highlight'));
                        document.querySelectorAll('.lyric-highlight').forEach(el => el.classList.remove('lyric-highlight'));

                        if (ev && ev.elements) {
                            ev.elements.forEach(set => set.forEach(el => {
                                // Diferenciar nota de letra
                                const isLyric = el.classList.contains('abcjs-lyric');
                                if(isLyric) {
                                    el.classList.add('lyric-highlight'); // Clase limpia para texto
                                } else {
                                    el.classList.add('abcjs-highlight'); // Clase SVG para notas
                                }
                            }));
                        }
                    },
                    beatCallback: (beatNumber) => visualizeBeat((beatNumber % (song.beats || 4)) + 1)
                });
                await synth.init({ visualObj: audioObj, options: { soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/" } });
                await synth.prime(); synth.start(); timingCallbacks.start(); synthControl = { synth };
            }
        }

        function toggleMetro() {
            if(state.isMetro) { stopAll(); return; }
            stopAll(); initAudio(); state.isMetro = true;
            document.getElementById('metro-btn').classList.add('bg-indigo-500', 'text-white');
            let song = state.songId === 'generated' ? state.generatedSong : SONGS[state.songId], currentBeat = 0, nextTime = state.audioCtx.currentTime;
            function schedule() {
                if(!state.isMetro) return;
                while (nextTime < state.audioCtx.currentTime + 0.1) {
                    playClick(nextTime, currentBeat % (song.beats || 4) === 0);
                    const b = (currentBeat % (song.beats || 4)) + 1;
                    setTimeout(() => visualizeBeat(b), (nextTime - state.audioCtx.currentTime) * 1000);
                    nextTime += 60.0 / state.tempo; currentBeat++;
                }
                metronomeTimer = setTimeout(schedule, 25);
            }
            schedule();
        }

        function playClick(time, strong) {
            const osc = state.audioCtx.createOscillator(), gain = state.audioCtx.createGain();
            osc.frequency.value = strong ? 1000 : 600; gain.gain.setValueAtTime(0.2, time); 
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05); osc.connect(gain); 
            gain.connect(state.audioCtx.destination); osc.start(time); osc.stop(time + 0.05);
        }

        function stopAll() {
            state.isPlaying = false; state.isMetro = false;
            if(synthControl) { synthControl.synth.stop(); synthControl = null; }
            if(timingCallbacks) { timingCallbacks.stop(); timingCallbacks = null; }
            if(metronomeTimer) { clearTimeout(metronomeTimer); metronomeTimer = null; }
            document.getElementById('play-btn').innerHTML = '<span>‚ñ∂ Iniciar Pr√°ctica</span>';
            document.getElementById('metro-btn').classList.remove('bg-indigo-500', 'text-white');
            document.querySelectorAll('.abcjs-highlight').forEach(el => el.classList.remove('abcjs-highlight'));
            document.querySelectorAll('.lyric-highlight').forEach(el => el.classList.remove('lyric-highlight'));
            document.querySelectorAll('.beat-dot').forEach(el => el.classList.remove('beat-active'));
        }

        function visualizeBeat(n) {
            document.querySelectorAll('.beat-dot').forEach(el => el.classList.remove('beat-active'));
            const dot = document.getElementById(`beat-${n}`);
            if(dot) dot.classList.add('beat-active');
        }

        function toggleFingers() {
            state.fingers = !state.fingers;
            document.getElementById('fingering-status').innerText = state.fingers ? 'ON' : 'OFF';
            renderScore();
        }

        function toggleCipher() {
            const status = document.getElementById('cipher-status');
            if (state.cipher === 'lat') { state.cipher = 'ang'; status.innerText = 'ANG'; }
            else if (state.cipher === 'ang') { state.cipher = 'off'; status.innerText = 'OFF'; }
            else { state.cipher = 'lat'; status.innerText = 'LAT'; }
            renderScore();
        }

        function showTooltip(e, pitch) {
            if(!e || pitch === undefined || pitch === null) return;
            const tooltip = document.getElementById('note-tooltip');
            const lang = (state.cipher === 'ang') ? 'ang' : 'lat';
            
            tooltip.innerText = pitchToNoteName(pitch, lang);
            
            tooltip.style.display = 'block'; 
            const x = e.pageX || (e.touches ? e.touches[0].pageX : 0);
            const y = e.pageY || (e.touches ? e.touches[0].pageY : 0);
            tooltip.style.left = x + 'px'; tooltip.style.top = y + 'px';
            setTimeout(() => tooltip.style.display = 'none', 1200);
        }

        function showNotification(msg) {
            const box = document.getElementById('notification-box');
            box.innerText = msg; box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 4000);
        }
    </script>
</body>
</html>
