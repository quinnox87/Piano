<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PianoClass: Lumina Edition</title>
    <!-- ABCjs para partituras -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.2.2/abcjs-basic-min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        lumina: {
                            bg: '#F8FAFC',      // Fondo suave seda
                            panel: '#FFFFFF',   // Paneles blancos limpios
                            border: '#E2E8F0',  // Bordes sutiles
                            text: '#334155',    // Texto principal
                            secondary: '#64748B',// Texto secundario
                            accent: '#818CF8',   // Lavanda suave
                            success: '#34D399',  // Verde menta
                            danger: '#F87171',   // Coral suave
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8FAFC;
            color: #334155;
            transition: background-color 0.5s ease;
        }

        .elegant-card {
            background: #FFFFFF;
            border: 1px solid #E2E8F0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            border-radius: 1.25rem;
            transition: all 0.3s ease;
        }

        .elegant-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: #CBD5E1;
        }

        /* --- ALTA VISIBILIDAD PARA LA PARTITURA --- */
        .abcjs-note { 
            fill: #0F172A !important; /* Negro profundo para m√°xima visibilidad */
            transition: fill 0.1s ease; 
        }
        .abcjs-staff { 
            stroke: #475569 !important; /* L√≠neas del pentagrama claras y n√≠tidas */
            stroke-width: 1.2;
        }
        
        /* Highlight de nota activa - Color √çndigo vibrante */
        .abcjs-highlight {
            fill: #4F46E5 !important;
            stroke: #4F46E5 !important;
            filter: drop-shadow(0px 0px 3px rgba(79, 70, 229, 0.4));
        }

        .abcjs-lyric { fill: #64748B; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 600; }
        .abcjs-fingering { fill: #4F46E5; font-weight: 800; font-size: 11px; }

        #paper {
            background: #FFFFFF;
            border-radius: 0.75rem;
            padding: 1rem;
        }
        #paper svg { width: 100%; height: auto; }

        /* Botones Estilo Lumina */
        .btn-lumina {
            display: inline-flex; items-center: center; justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600; font-size: 0.75rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.02em;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #818CF8, #6366F1);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(99, 102, 241, 0.3); }
        
        .btn-ghost {
            background-color: #F1F5F9;
            color: #475569;
            border: 1px solid #E2E8F0;
        }
        .btn-ghost:hover { background-color: #E2E8F0; color: #1E293B; }

        .btn-stop {
            background-color: #FEE2E2;
            color: #EF4444;
            border: 1px solid #FCA5A5;
        }
        .btn-stop:hover { background-color: #FCA5A5; color: white; }

        /* Rejilla de opciones IA */
        .ai-option-btn {
            background-color: #FFFFFF;
            border: 1px solid #E2E8F0;
            color: #64748B;
            padding: 1rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .ai-option-btn:hover {
            border-color: #818CF8;
            background-color: #EEF2FF;
            color: #4F46E5;
        }
        .ai-option-btn.selected {
            background-color: #EEF2FF;
            color: #4F46E5;
            border-color: #6366F1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        /* Metr√≥nomo */
        .beat-dot { transition: all 0.15s; background-color: #E2E8F0; width: 12px; height: 12px; }
        .beat-active { background-color: #34D399 !important; box-shadow: 0 0 12px rgba(52, 211, 153, 0.6); transform: scale(1.3); }

        /* Notificaci√≥n */
        #notification-box {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%);
            padding: 1rem 2.5rem; border-radius: 1rem;
            background: #1E293B; color: white; font-weight: 500;
            z-index: 100; display: none;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        #note-tooltip {
            position: absolute; display: none; background: #1E293B; color: white;
            padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600;
            pointer-events: none; z-index: 50; transform: translate(-50%, -150%);
        }

        input[type="range"] { accent-color: #818CF8; }
        
        .modal-overlay {
            position: absolute; inset: 0; background: rgba(255, 255, 255, 0.8);
            z-index: 40; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }

        /* Personalizaci√≥n de scroll */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #F8FAFC; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
    </style>
</head>
<body class="antialiased min-h-screen pb-12">

    <div id="note-tooltip">Nota</div>
    <div id="notification-box"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <!-- HEADER ELEGANTE -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-slate-200 pb-8">
            <div class="text-center md:text-left">
                <h1 class="text-4xl font-extrabold tracking-tight text-slate-900">
                    Piano<span class="text-indigo-500">Class</span>
                </h1>
                <p class="text-slate-500 font-medium text-base mt-1">Lumina Edition: Pr√°ctica Consciente</p>
            </div>
            
            <div class="mt-6 md:mt-0 flex items-center gap-4">
                <button onclick="toggleApiModal()" class="flex items-center gap-2 bg-white hover:bg-slate-50 border border-slate-200 px-4 py-2 rounded-xl transition-all shadow-sm group">
                    <span id="api-status-icon" class="text-slate-400 group-hover:text-amber-500">üîë</span>
                    <span class="text-xs font-bold text-slate-600 uppercase tracking-wider">API Config</span>
                </button>
                <div class="bg-indigo-50 border border-indigo-100 px-5 py-2 rounded-xl shadow-sm flex items-center gap-3">
                    <div class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
                    <span class="text-xs font-bold text-indigo-700 uppercase tracking-widest">Enfoque Activo</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- PANEL IZQUIERDO (CONTROLES) -->
            <div class="lg:col-span-3 space-y-6">
                
                <!-- SELECTOR -->
                <div class="elegant-card p-6">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 block">Selecci√≥n de Repertorio</label>
                    <select id="song-selector" class="w-full bg-slate-50 text-slate-700 text-sm font-semibold py-3 px-4 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-200 transition-all cursor-pointer">
                        <option value="minuet">Minueto en Sol (Bach)</option>
                        <option value="scale_c">Escala T√©cnica (Do Mayor)</option>
                        <option value="ode_joy">Oda a la Alegr√≠a (Beethoven)</option>
                        <option value="vals_1">Vals 1 (Iniciaci√≥n)</option>
                        <option value="brahms_lullaby">Canci√≥n de Cuna (Brahms)</option>
                        <option value="cancan">Can-Can (Offenbach)</option>
                    </select>
                    <div id="song-meta" class="mt-4 text-[11px] text-slate-400 italic">J.S. Bach / Barroco</div>
                </div>

                <!-- MOTOR DE AUDIO -->
                <div class="elegant-card p-6">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-5">Controles de Ejecuci√≥n</h3>
                    <div class="space-y-3">
                        <button id="play-btn" class="btn-lumina btn-primary w-full text-white text-sm">
                            <span>‚ñ∂ Iniciar Sesi√≥n</span>
                        </button>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="stop-btn" class="btn-lumina btn-stop text-xs">‚èπ Detener</button>
                            <button id="metro-btn" class="btn-lumina btn-ghost text-xs">‚åõ Metr√≥nomo</button>
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t border-slate-100">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Velocidad (BPM)</span>
                            <span id="tempo-display" class="text-xl font-bold text-indigo-600">110</span>
                        </div>
                        <input type="range" id="tempo-slider" min="40" max="200" value="110" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <!-- ASISTENTES -->
                <div class="elegant-card p-6">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-5">Soporte Cognitivo</h3>
                    <div class="space-y-4">
                        <button id="fingering-btn" class="w-full btn-lumina btn-ghost justify-between group">
                            <span class="text-slate-600">Digitaci√≥n</span>
                            <span id="fingering-status" class="bg-indigo-100 text-indigo-600 px-2.5 py-0.5 rounded-full text-[10px] font-bold">ON</span>
                        </button>
                        <button id="cipher-btn" class="w-full btn-lumina btn-ghost justify-between group">
                            <span class="text-slate-600">Cifrado</span>
                            <span id="cipher-status" class="bg-slate-200 text-slate-500 px-2.5 py-0.5 rounded-full text-[10px] font-bold">LAT</span>
                        </button>
                    </div>
                </div>

                <!-- GENERADOR IA -->
                <div class="elegant-card p-6 border-dashed border-indigo-200 bg-indigo-50/30">
                    <button onclick="toggleAiGenerator()" class="w-full flex flex-col items-center gap-3 group transition-all">
                        <span class="text-3xl filter drop-shadow-sm group-hover:scale-110 transition-transform">‚ú®</span>
                        <span class="text-[11px] font-bold text-indigo-400 group-hover:text-indigo-600 uppercase tracking-widest">Generar Nuevo Ejercicio</span>
                    </button>
                </div>
            </div>

            <!-- PANEL DERECHO (PARTITURA) -->
            <div class="lg:col-span-9">
                <div id="main-paper-container" class="elegant-card p-0 flex flex-col min-h-[700px] overflow-hidden relative">
                    
                    <!-- BARRA SUPERIOR PARTITURA -->
                    <div class="px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <div class="flex gap-4" id="beat-container"></div>
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-400"></span> Modo: Lectura Fluida
                        </div>
                    </div>

                    <!-- MODAL COMPOSITOR IA -->
                    <div id="ai-generator-overlay" class="absolute inset-0 z-30 bg-white/95 p-12 hidden animate-fade-in">
                        <div class="flex justify-between items-start mb-12">
                            <div>
                                <h3 class="text-3xl font-bold text-slate-900">Compositor Asistente ‚ú®</h3>
                                <p class="text-sm text-slate-500 mt-1">Entrenamiento a medida para neuropsicolog√≠a musical.</p>
                            </div>
                            <button onclick="toggleAiGenerator()" class="text-slate-400 hover:text-slate-900 text-3xl transition-colors">‚úï</button>
                        </div>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-6 mb-16">
                            <button onclick="selectAiOption('Cl√°sica', this)" class="ai-option-btn">üéπ Cl√°sica</button>
                            <button onclick="selectAiOption('Moderna', this)" class="ai-option-btn">üé∏ Moderna</button>
                            <button onclick="selectAiOption('Bandas Sonoras', this)" class="ai-option-btn">üé¨ Cine</button>
                            <button onclick="selectAiOption('Mano Derecha', this)" class="ai-option-btn">‚úã Derecha</button>
                            <button onclick="selectAiOption('Mano Izquierda', this)" class="ai-option-btn">ü§ö Izquierda</button>
                            <button onclick="selectAiOption('Acordes', this)" class="ai-option-btn">üéº Acordes</button>
                            <button onclick="selectAiOption('Escalas', this)" class="ai-option-btn">üìè Escalas</button>
                            <button onclick="selectAiOption('Calentamiento', this)" class="ai-option-btn">‚òï Calentar</button>
                        </div>

                        <div class="flex flex-col items-center gap-5">
                            <button id="main-gen-btn" onclick="generateExercise()" class="btn-lumina btn-primary text-white min-w-[320px] opacity-50 cursor-not-allowed py-5 text-lg rounded-2xl" disabled>
                                <span id="gen-btn-text">Generar Partitura Ahora</span>
                                <span id="gen-btn-loader" class="hidden animate-spin text-xl">‚ü≥</span>
                            </button>
                            <p id="api-warning" class="text-[10px] text-danger font-bold uppercase tracking-widest hidden italic">‚ö† Debes introducir tu clave API primero</p>
                        </div>
                    </div>

                    <!-- MODAL API CONFIG -->
                    <div id="api-modal-overlay" class="modal-overlay hidden">
                        <div class="bg-white border border-slate-200 p-10 rounded-3xl shadow-2xl w-full max-w-md animate-slide-up">
                            <h3 class="text-2xl font-bold text-slate-900 mb-2 text-center">Gemini API Key</h3>
                            <p class="text-xs text-slate-500 mb-8 text-center leading-relaxed">Configura tu clave de Google AI Studio para activar la inteligencia artificial.</p>
                            
                            <div class="space-y-6">
                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Clave de Acceso</label>
                                    <input type="password" id="api-key-input" placeholder="Pega tu clave aqu√≠..." class="w-full bg-slate-50 border border-slate-200 text-slate-700 p-4 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300 transition-all">
                                </div>
                                <div class="flex gap-4 pt-2">
                                    <button onclick="toggleApiModal()" class="flex-1 btn-lumina btn-ghost rounded-2xl">Cerrar</button>
                                    <button onclick="saveApiKey()" class="flex-1 btn-lumina btn-primary rounded-2xl">Guardar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LIENZO -->
                    <div class="flex-grow p-12 overflow-x-auto flex items-center justify-center bg-slate-100 relative">
                        <div id="paper-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10 hidden">
                             <div class="flex flex-col items-center gap-5">
                                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-500 border-r-transparent"></div>
                                <span class="text-indigo-600 font-bold text-xs uppercase tracking-widest">Escribiendo m√∫sica...</span>
                             </div>
                        </div>
                        <div id="paper" class="w-full max-w-4xl shadow-sm border border-slate-200"></div>
                    </div>

                    <!-- PIE DE INFORMACI√ìN -->
                    <div class="px-8 py-5 border-t border-slate-100 bg-slate-50/50 flex justify-between items-center text-[11px] font-bold text-slate-400 uppercase tracking-widest">
                        <div class="flex space-x-12">
                            <div>Comp√°s: <span id="time-sig" class="text-indigo-600 ml-1">--</span></div>
                            <div>Tonalidad: <span id="key-sig" class="text-indigo-600 ml-1">--</span></div>
                        </div>
                        <div class="flex items-center gap-2 opacity-60">
                            <span class="text-indigo-400">‚ö°</span> Motor de Renderizado ABCjs
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        let apiKey = ""; 

        const SONGS = {
            'minuet': { title: "Minueto en Sol Mayor", subtitle: "J.S. Bach / Barroco", tempo: 110, beats: 3, key: "G", time: "3/4", abc: `X:1\nT:\nM:3/4\nL:1/8\nQ:1/4=110\nK:G\nV:1 treble\nV:2 bass\n[V:1] !5!d2 !1!G!2!A !3!B!4!c | !5!d2 !1!G2 !1!G2 | !5!e2 !4!c!5!d !3!e!4!f | !5!g2 !1!G2 !1!G2 |\nw: Re Sol La Si Do | Re Sol Sol | Mi Do Re Mi Fa# | Sol Sol Sol |\n[V:2] !5!G,2 !3!B,2 !1!D2 | !5!G,4 !5!G,2 | !5!C2 !3!E2 !1!G2 | !5!C4 !5!C2 |\nw: Sol Si Re | Sol Sol | Do Mi Sol | Do Do |` },
            'scale_c': { title: "Escala de Do Mayor", subtitle: "T√©cnica Fundamental", tempo: 80, beats: 4, key: "C", time: "4/4", abc: `X:1\nT:\nM:4/4\nL:1/4\nQ:1/4=80\nK:C\nV:1 treble\nV:2 bass\n[V:1] !1!C !2!D !3!E !1!F | !2!G !3!A !4!B !5!c | !5!c !4!B !3!A !2!G | !1!F !3!E !2!D !1!C |\nw: Do Re Mi Fa | Sol La Si Do | Do Si La Sol | Fa Mi Re Do |\n[V:2] !5!C, !4!D, !3!E, !2!F, | !1!G, !3!A, !2!B, !1!C | !1!C !2!B,, !3!A,, !1!G,, | !2!F,, !3!E,, !4!D,, !5!C,, |\nw: Do Re Mi Fa | Sol La Si Do | Do Si La Sol | Fa Mi Re Do |` },
            'ode_joy': { title: "Oda a la Alegr√≠a", subtitle: "L. van Beethoven", tempo: 120, beats: 4, key: "G", time: "4/4", abc: `X:1\nT:\nM:4/4\nL:1/4\nQ:1/4=120\nK:G\nV:1 treble\nV:2 bass\n[V:1] !3!B !3!B !4!c !5!d | !5!d !4!c !3!B !2!A | !1!G !1!G !2!A !3!B | !3!B>!2!A !2!A2 |\nw: Si Si Do Re | Re Do Si La | Sol Sol La Si | Si La La |\n[V:2] !1!G,2 !2!B,2 | !1!D2 !1!G,2 | !2!E,2 !3!C2 | !1!D,4 |\nw: Sol Si | Re Sol | Mi Do | Re |` },
            'vals_1': { title: "Vals Iniciaci√≥n", subtitle: "Coordinaci√≥n 3/4", tempo: 100, beats: 3, key: "G", time: "3/4", abc: `X:1\nT:\nM:3/4\nL:1/4\nQ:1/4=100\nK:G\nV:1 treble\nV:2 bass\n[V:1] !1!G !3!B !5!d | !5!d2 !5!d | !4!c !2!A !4!c | !3!B2 !1!G |\nw: Sol Si Re | Re Re | Do La Do | Si Sol |\n[V:2] !5!G,, [G,B,D] [G,B,D] | !5!G,, [G,B,D] [G,B,D] | !2!F,, [F,A,C] [F,A,C] | !5!G,, [G,B,D] [G,B,D] |\nw: Sol Sol-maj Sol-maj | Sol Sol-maj Sol-maj | Fa Fa-maj Fa-maj | Sol Sol-maj Sol-maj |` },
            'brahms_lullaby': { title: "Canci√≥n de Cuna", subtitle: "J. Brahms", tempo: 80, beats: 3, key: "C", time: "3/4", abc: `X:1\nT:\nM:3/4\nL:1/4\nQ:1/4=80\nK:C\nV:1 treble\nV:2 bass\n[V:1] !3!E E !5!G | !3!E E !5!G | !3!E !5!G !5!c | !4!B2 !2!A |\nw: Mi Mi Sol | Mi Mi Sol | Mi Sol Do | Si La |\n[V:2] !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] |\nw: Do Do-maj Do-maj | Do Do-maj Do-maj | Do Do-maj Do-maj | Sol Sol-maj Sol-maj |` },
            'cancan': { title: "Can-Can", subtitle: "J. Offenbach", tempo: 130, beats: 4, key: "C", time: "4/4", abc: `X:1\nT:\nM:4/4\nL:1/4\nQ:1/4=130\nK:C\nV:1 treble\nV:2 bass\n[V:1] !1!C !1!C !2!D !2!D | !3!E !3!E !4!F !4!F | !5!G !5!G !5!G !5!G | !3!E2 !1!C2 |\nw: Do Do Re Re | Mi Mi Fa Fa | Sol Sol Sol Sol | Mi Do |\n[V:2] !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, |\nw: Do Sol Do Sol | Do Sol Do Sol | Do Sol Do Sol | Do Sol Do Sol |` }
        };

        const noteNames = {
            lat: ["Do", "Do#", "Re", "Re#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"],
            ang: ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"],
            map: { "Do": "C", "Re": "D", "Mi": "E", "Fa": "F", "Sol": "G", "La": "A", "Si": "B" }
        };

        let state = { songId: 'minuet', tempo: 110, fingers: true, cipher: 'lat', isPlaying: false, isMetro: false, audioCtx: null, generatedSong: null, currentOption: null };
        let abcInstance, synthControl, timingCallbacks, metronomeTimer;

        document.addEventListener('DOMContentLoaded', () => {
            loadSong('minuet');
            setupListeners();
        });

        function setupListeners() {
            document.getElementById('song-selector').addEventListener('change', (e) => loadSong(e.target.value));
            document.getElementById('fingering-btn').addEventListener('click', toggleFingers);
            document.getElementById('cipher-btn').addEventListener('click', toggleCipher);
            document.getElementById('play-btn').addEventListener('click', playPiano);
            document.getElementById('stop-btn').addEventListener('click', stopAll);
            document.getElementById('metro-btn').addEventListener('click', toggleMetro);
            document.getElementById('tempo-slider').addEventListener('input', (e) => updateTempo(0, parseInt(e.target.value)));
        }

        // --- API & IA ---
        function toggleApiModal() { document.getElementById('api-modal-overlay').classList.toggle('hidden'); }
        function toggleAiGenerator() { document.getElementById('ai-generator-overlay').classList.toggle('hidden'); }

        function saveApiKey() {
            const input = document.getElementById('api-key-input').value;
            if(input) {
                apiKey = input;
                document.getElementById('api-status-icon').className = 'text-amber-500';
                document.getElementById('api-warning').classList.add('hidden');
                toggleApiModal();
                showNotification("API Key configurada correctamente.");
            }
        }

        function selectAiOption(option, element) {
            state.currentOption = option;
            document.querySelectorAll('.ai-option-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            const genBtn = document.getElementById('main-gen-btn');
            genBtn.disabled = false;
            genBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            if(!apiKey) document.getElementById('api-warning').classList.remove('hidden');
        }

        async function callGemini(promptText) {
            if(!apiKey) return null;
            const delays = [1000, 2000, 4000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) {
                    if (i === delays.length) { showNotification("Error de conexi√≥n IA."); return null; }
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        async function generateExercise() {
            if (!state.currentOption || !apiKey) return;
            const btn = document.getElementById('main-gen-btn'), loader = document.getElementById('gen-btn-loader'), 
                  text = document.getElementById('gen-btn-text'), paperLoading = document.getElementById('paper-loading');
            btn.disabled = true; loader.classList.remove('hidden'); text.classList.add('hidden'); paperLoading.classList.remove('hidden');

            let handRule = state.currentOption === 'Mano Izquierda' ? "V:1 clef=bass" : (state.currentOption === 'Mano Derecha' ? "V:1 clef=treble" : "V:1 (derecha) y V:2 clef=bass (izquierda)");

            const prompt = `Genera un ejercicio de piano corto (4 compases) en formato ABC bas√°ndote en: "${state.currentOption}".
REGLAS: X:1, T:Ejercicio IA, M:4/4, L:1/4, K:C. ${handRule}. 
CIFRADO: l√≠nea 'w:' inmediatamente despu√©s de la m√∫sica con nombres en espa√±ol (Do, Re...). Incluye digitaci√≥n (!1!-!5!). Devuelve SOLO c√≥digo plano.`;

            let abcCode = await callGemini(prompt);
            if (abcCode) {
                abcCode = abcCode.replace(/```[a-z]*\n?/gi, '').replace(/```/g, '').trim();
                state.generatedSong = { title: "Composici√≥n IA", subtitle: `Enfoque: ${state.currentOption}`, tempo: 100, beats: 4, key: "C", time: "4/4", abc: abcCode };
                const timeMatch = abcCode.match(/M:(\d+)\/(\d+)/);
                if (timeMatch) state.generatedSong.beats = parseInt(timeMatch[1]);
                loadSong('generated');
                toggleAiGenerator();
            }
            btn.disabled = false; loader.classList.add('hidden'); text.classList.remove('hidden'); paperLoading.classList.add('hidden');
        }

        // --- RENDER & AUDIO ---
        function loadSong(id) {
            stopAll();
            let song = (id === 'generated' && state.generatedSong) ? state.generatedSong : SONGS[id];
            state.songId = id;
            document.getElementById('song-meta').innerText = song.subtitle || "Pieza Personalizada";
            updateTempo(0, song.tempo);
            document.getElementById('time-sig').innerText = song.time;
            document.getElementById('key-sig').innerText = song.key;
            const beatContainer = document.getElementById('beat-container');
            beatContainer.innerHTML = '';
            for(let i=0; i<song.beats; i++) {
                const dot = document.createElement('div');
                dot.className = `beat-dot rounded-full`;
                dot.id = `beat-${i+1}`;
                beatContainer.appendChild(dot);
            }
            renderScore();
        }

        function renderScore() {
            let song = state.songId === 'generated' ? state.generatedSong : SONGS[state.songId];
            let abc = song.abc;
            if (abc.includes('Q:')) abc = abc.replace(/Q:1\/4=\d+/, `Q:1/4=${state.tempo}`);
            else abc = abc.replace('K:', `Q:1/4=${state.tempo}\nK:`);
            if(!state.fingers) abc = abc.replace(/![1-5]!/g, "");

            if(state.cipher === 'off') abc = abc.split('\n').filter(l => !l.trim().startsWith('w:')).join('\n');
            else if (state.cipher === 'ang') {
                abc = abc.split('\n').map(line => {
                    if (line.trim().startsWith('w:')) {
                        let content = line.replace(/^\s*w:\s*/, '');
                        Object.keys(noteNames.map).forEach(k => {
                            const regex = new RegExp(k + '(?![a-z])', 'g');
                            content = content.replace(regex, noteNames.map[k]);
                        });
                        return 'w: ' + content;
                    }
                    return line;
                }).join('\n');
            }

            abcInstance = ABCJS.renderAbc("paper", abc, {
                responsive: 'resize', add_classes: true, staffwidth: 800, scale: 1.1,
                clickListener: (abcElem) => { if (abcElem && abcElem.el_type === "note") showTooltip(window.event, abcElem.pitches[0].pitch); }
            })[0];
        }

        function updateTempo(delta, exact = null) {
            state.tempo = exact ? exact : Math.max(40, Math.min(220, state.tempo + delta));
            document.getElementById('tempo-display').innerText = state.tempo;
            document.getElementById('tempo-slider').value = state.tempo;
            if(state.isPlaying || state.isMetro) { const wasPlaying = state.isPlaying; stopAll(); if(wasPlaying) playPiano(); } else renderScore();
        }

        function initAudio() {
            if (!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (state.audioCtx.state === 'suspended') state.audioCtx.resume();
        }

        async function playPiano() {
            if (state.isPlaying) { stopAll(); return; }
            initAudio(); state.isPlaying = true;
            document.getElementById('play-btn').classList.replace('btn-primary', 'btn-ghost');
            document.getElementById('play-btn').innerHTML = '<span>‚è∏ Pausar Sesi√≥n</span>';

            if (ABCJS.synth.supportsAudio()) {
                const synth = new ABCJS.synth.CreateSynth();
                let song = state.songId === 'generated' ? state.generatedSong : SONGS[state.songId];
                const audioObj = ABCJS.renderAbc("paper", song.abc.replace(/Q:1\/4=\d+/, `Q:1/4=${state.tempo}`), { responsive: 'resize' })[0];
                timingCallbacks = new ABCJS.TimingCallbacks(audioObj, {
                    qpm: state.tempo,
                    eventCallback: (ev) => {
                        document.querySelectorAll('.abcjs-highlight').forEach(el => el.classList.remove('abcjs-highlight'));
                        if (ev && ev.elements) {
                            ev.elements.forEach(set => set.forEach(el => {
                                el.classList.add('abcjs-highlight');
                                const nid = Array.from(el.classList).find(c => c.startsWith('abcjs-n'));
                                if(nid) document.querySelectorAll(`.${nid}.abcjs-lyric`).forEach(l => l.classList.add('abcjs-highlight'));
                            }));
                        }
                    },
                    beatCallback: (beatNumber) => visualizeBeat((beatNumber % song.beats) + 1)
                });
                await synth.init({ visualObj: audioObj, options: { soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/" } });
                await synth.prime(); synth.start(); timingCallbacks.start(); synthControl = { synth };
            }
        }

        function toggleMetro() {
            if(state.isMetro) { stopAll(); return; }
            stopAll(); initAudio(); state.isMetro = true;
            document.getElementById('metro-btn').classList.add('bg-indigo-500', 'text-white');
            let song = state.songId === 'generated' ? state.generatedSong : SONGS[state.songId], currentBeat = 0, nextTime = state.audioCtx.currentTime;
            function schedule() {
                if(!state.isMetro) return;
                while (nextTime < state.audioCtx.currentTime + 0.1) {
                    playClick(nextTime, currentBeat % song.beats === 0);
                    const b = (currentBeat % song.beats) + 1;
                    setTimeout(() => visualizeBeat(b), (nextTime - state.audioCtx.currentTime) * 1000);
                    nextTime += 60.0 / state.tempo; currentBeat++;
                }
                metronomeTimer = setTimeout(schedule, 25);
            }
            schedule();
        }

        function playClick(time, strong) {
            const osc = state.audioCtx.createOscillator(), gain = state.audioCtx.createGain();
            osc.frequency.value = strong ? 1000 : 600; gain.gain.setValueAtTime(0.2, time); 
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05); osc.connect(gain); 
            gain.connect(state.audioCtx.destination); osc.start(time); osc.stop(time + 0.05);
        }

        function stopAll() {
            state.isPlaying = false; state.isMetro = false;
            if(synthControl) { synthControl.synth.stop(); synthControl = null; }
            if(timingCallbacks) { timingCallbacks.stop(); timingCallbacks = null; }
            if(metronomeTimer) { clearTimeout(metronomeTimer); metronomeTimer = null; }
            const btn = document.getElementById('play-btn');
            btn.classList.replace('btn-ghost', 'btn-primary'); btn.innerHTML = '<span>‚ñ∂ Iniciar Sesi√≥n</span>';
            document.getElementById('metro-btn').classList.remove('bg-indigo-500', 'text-white');
            document.querySelectorAll('.abcjs-highlight').forEach(el => el.classList.remove('abcjs-highlight'));
            document.querySelectorAll('.beat-dot').forEach(el => el.classList.remove('beat-active'));
        }

        function visualizeBeat(n) {
            document.querySelectorAll('.beat-dot').forEach(el => el.classList.remove('beat-active'));
            const dot = document.getElementById(`beat-${n}`);
            if(dot) dot.classList.add('beat-active');
        }

        function toggleFingers() {
            state.fingers = !state.fingers;
            document.getElementById('fingering-status').innerText = state.fingers ? 'ON' : 'OFF';
            document.getElementById('fingering-status').className = state.fingers ? 'bg-indigo-100 text-indigo-600 px-2.5 py-0.5 rounded-full text-[10px] font-bold' : 'bg-slate-200 text-slate-500 px-2.5 py-0.5 rounded-full text-[10px] font-bold';
            renderScore();
        }

        function toggleCipher() {
            const status = document.getElementById('cipher-status');
            if (state.cipher === 'lat') { state.cipher = 'ang'; status.innerText = 'ANG'; status.classList.replace('bg-slate-200', 'bg-indigo-100'); status.classList.replace('text-slate-500', 'text-indigo-600'); }
            else if (state.cipher === 'ang') { state.cipher = 'off'; status.innerText = 'OFF'; status.classList.replace('bg-indigo-100', 'bg-slate-200'); status.classList.replace('text-indigo-600', 'text-slate-500'); }
            else { state.cipher = 'lat'; status.innerText = 'LAT'; }
            renderScore();
        }

        function showTooltip(e, pitch) {
            if(!e) return;
            const tooltip = document.getElementById('note-tooltip');
            tooltip.innerText = state.cipher === 'ang' ? noteNames.ang[pitch % 12] : noteNames.lat[pitch % 12];
            tooltip.style.display = 'block'; tooltip.style.left = e.pageX + 'px'; tooltip.style.top = e.pageY + 'px';
            setTimeout(() => tooltip.style.display = 'none', 1500);
        }

        function showNotification(msg) {
            const box = document.getElementById('notification-box');
            box.innerText = msg; box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 4000);
        }
    </script>
</body>
</html>
