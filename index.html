<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PianoClass: Lumina Edition (Fixed Ciphers)</title>
    <!-- ABCjs para partituras -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.2.2/abcjs-basic-min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        lumina: {
                            bg: '#F8FAFC',
                            panel: '#FFFFFF',
                            border: '#E2E8F0',
                            text: '#334155',
                            secondary: '#64748B',
                            accent: '#818CF8',
                            success: '#34D399',
                            danger: '#F87171',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8FAFC;
            color: #334155;
            transition: background-color 0.5s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .elegant-card {
            background: #FFFFFF;
            border: 1px solid #E2E8F0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .elegant-card { border-radius: 1.25rem; }
        }

        /* ALTA VISIBILIDAD */
        .abcjs-note { fill: #0F172A !important; transition: fill 0.1s ease; }
        .abcjs-staff { stroke: #475569 !important; stroke-width: 1.2; }
        .abcjs-highlight { fill: #4F46E5 !important; stroke: #4F46E5 !important; filter: drop-shadow(0px 0px 3px rgba(79, 70, 229, 0.4)); }
        .abcjs-lyric { fill: #64748B; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 600; }
        .abcjs-fingering { fill: #4F46E5; font-weight: 800; font-size: 10px; }

        #paper { background: #FFFFFF; width: 100%; border-radius: 0.75rem; }
        #paper svg { width: 100%; height: auto; display: block; margin: 0 auto; }

        /* Botones */
        .btn-lumina {
            display: inline-flex; items-center: center; justify-content: center;
            padding: 0.75rem 1rem; border-radius: 0.75rem;
            font-weight: 600; font-size: 0.75rem; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.02em; cursor: pointer; user-select: none;
        }
        .btn-primary { background: linear-gradient(135deg, #818CF8, #6366F1); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }
        .btn-ghost { background-color: #F1F5F9; color: #475569; border: 1px solid #E2E8F0; }
        .btn-stop { background-color: #FEE2E2; color: #EF4444; border: 1px solid #FCA5A5; }

        /* Opciones IA */
        .ai-option-btn {
            background-color: #FFFFFF; border: 1px solid #E2E8F0; color: #64748B;
            padding: 0.75rem 0.5rem; border-radius: 0.75rem; font-size: 0.75rem; font-weight: 600;
            transition: all 0.2s; text-align: center;
        }
        .ai-option-btn.selected { background-color: #EEF2FF; color: #4F46E5; border-color: #6366F1; }

        /* Metr√≥nomo */
        .beat-dot { transition: all 0.15s; background-color: #E2E8F0; width: 10px; height: 10px; border-radius: 50%; }
        .beat-active { background-color: #34D399 !important; box-shadow: 0 0 10px rgba(52, 211, 153, 0.6); transform: scale(1.2); }

        /* Notificaci√≥n */
        #notification-box {
            position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
            padding: 0.75rem 1.5rem; border-radius: 0.75rem; background: #1E293B; color: white;
            z-index: 100; display: none; width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        #note-tooltip {
            position: absolute; display: none; background: #1E293B; color: white;
            padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;
            pointer-events: none; z-index: 50; transform: translate(-50%, -150%);
        }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9);
            z-index: 50; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(6px); padding: 1rem;
        }
    </style>
</head>
<body class="antialiased min-h-screen pb-6 md:pb-12">

    <div id="note-tooltip">Nota</div>
    <div id="notification-box"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8 w-full">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 md:mb-10 border-b border-slate-200 pb-6 md:pb-8 gap-4">
            <div class="text-center md:text-left w-full md:w-auto">
                <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">
                    Piano<span class="text-indigo-500">Class</span>
                </h1>
                <p class="text-slate-500 font-medium text-sm md:text-base mt-0.5">Lumina: Sesi√≥n de Larga Duraci√≥n</p>
            </div>
            
            <div class="flex items-center justify-center md:justify-end gap-2 md:gap-4 w-full md:w-auto">
                <button onclick="toggleApiModal()" class="flex items-center gap-2 bg-white hover:bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl shadow-sm group">
                    <span id="api-status-icon" class="text-slate-400 group-hover:text-amber-500">üîë</span>
                    <span class="text-[10px] md:text-xs font-bold text-slate-600 uppercase tracking-wider">API</span>
                </button>
                <div class="bg-indigo-50 border border-indigo-100 px-3 md:px-5 py-2 rounded-xl shadow-sm flex items-center gap-2 md:gap-3">
                    <div class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-indigo-500 animate-pulse"></div>
                    <span class="text-[10px] md:text-xs font-bold text-indigo-700 uppercase tracking-widest">Resistencia</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
            
            <div class="lg:col-span-3 space-y-4 md:space-y-6">
                
                <div class="elegant-card p-4 md:p-6">
                    <label class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 md:mb-4 block">Repertorio Maestro</label>
                    <select id="song-selector" class="w-full bg-slate-50 text-slate-700 text-xs md:text-sm font-semibold py-2.5 px-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-200 transition-all cursor-pointer">
                        <option value="minuet">Minueto en Sol (Bach) - Completo</option>
                        <option value="scale_c">Escala Do Mayor - 2 Octavas</option>
                        <option value="ode_joy">Oda a la Alegr√≠a - Estructura A-B-A</option>
                        <option value="vals_1">Vals No. 1 - Desarrollo</option>
                        <option value="brahms_lullaby">Canci√≥n de Cuna - Versi√≥n Extendida</option>
                        <option value="cancan">Can-Can - Galop Final</option>
                    </select>
                    <div id="song-meta" class="mt-3 text-[10px] text-slate-400 italic">Bach / Barroco</div>
                </div>

                <div class="elegant-card p-4 md:p-6">
                    <h3 class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Controles</h3>
                    <div class="space-y-3">
                        <button id="play-btn" class="btn-lumina btn-primary w-full text-white text-xs md:text-sm">‚ñ∂ Iniciar Pr√°ctica</button>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="stop-btn" class="btn-lumina btn-stop text-[10px]">‚èπ Parar</button>
                            <button id="metro-btn" class="btn-lumina btn-ghost text-[10px]">‚åõ Metr.</button>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-100">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase">Tempo (BPM)</span>
                            <span id="tempo-display" class="text-lg md:text-xl font-bold text-indigo-600">110</span>
                        </div>
                        <input type="range" id="tempo-slider" min="40" max="200" value="110" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <div class="elegant-card p-4 md:p-6">
                    <h3 class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Asistentes</h3>
                    <div class="space-y-3">
                        <button id="fingering-btn" class="w-full btn-lumina btn-ghost justify-between">
                            <span class="text-slate-600">Digitaci√≥n</span>
                            <span id="fingering-status" class="bg-indigo-100 text-indigo-600 px-2.5 py-0.5 rounded-full text-[9px] font-bold">ON</span>
                        </button>
                        <button id="cipher-btn" class="w-full btn-lumina btn-ghost justify-between">
                            <span class="text-slate-600">Cifrado</span>
                            <span id="cipher-status" class="bg-slate-200 text-slate-500 px-2.5 py-0.5 rounded-full text-[9px] font-bold">LAT</span>
                        </button>
                    </div>
                </div>

                <div class="elegant-card p-4 border-dashed border-indigo-200 bg-indigo-50/30">
                    <button onclick="toggleAiGenerator()" class="w-full flex flex-col items-center gap-2 group transition-all">
                        <span class="text-2xl filter drop-shadow-sm group-hover:scale-110 transition-transform">‚ú®</span>
                        <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest text-center">Generar Obra IA</span>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-9">
                <div id="main-paper-container" class="elegant-card p-0 flex flex-col min-h-[500px] md:min-h-[800px] overflow-hidden relative">
                    
                    <div class="px-4 md:px-8 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <div class="flex gap-2 md:gap-4" id="beat-container"></div>
                        <div class="text-[8px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1 md:gap-2">
                            <span class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-emerald-400"></span> 
                            <span>Modo: Resistencia Cognitiva</span>
                        </div>
                    </div>

                    <!-- MODAL COMPOSITOR IA -->
                    <div id="ai-generator-overlay" class="fixed inset-0 z-[60] bg-white/95 p-6 md:p-12 hidden animate-fade-in flex flex-col">
                        <div class="flex justify-between items-start mb-6 md:mb-12">
                            <div>
                                <h3 class="text-xl md:text-3xl font-bold text-slate-900">Compositor Maestro ‚ú®</h3>
                                <p class="text-xs md:text-sm text-slate-500 mt-0.5">Generaci√≥n de partituras extensas con IA.</p>
                            </div>
                            <button onclick="toggleAiGenerator()" class="text-slate-400 hover:text-slate-900 text-2xl md:text-3xl p-2 transition-colors">‚úï</button>
                        </div>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 md:gap-6 mb-8 overflow-y-auto pr-2">
                            <button onclick="selectAiOption('Cl√°sica', this)" class="ai-option-btn">üéπ Cl√°sica</button>
                            <button onclick="selectAiOption('Moderna', this)" class="ai-option-btn">üé∏ Moderna</button>
                            <button onclick="selectAiOption('Bandas Sonoras', this)" class="ai-option-btn">üé¨ Cine</button>
                            <button onclick="selectAiOption('Mano Derecha', this)" class="ai-option-btn">‚úã Der.</button>
                            <button onclick="selectAiOption('Mano Izquierda', this)" class="ai-option-btn">ü§ö Izq.</button>
                            <button onclick="selectAiOption('Acordes', this)" class="ai-option-btn">üéº Acordes</button>
                            <button onclick="selectAiOption('Escalas', this)" class="ai-option-btn">üìè Escalas</button>
                            <button onclick="selectAiOption('Calentamiento', this)" class="ai-option-btn">‚òï Calentar</button>
                        </div>

                        <div class="mt-auto flex flex-col items-center gap-4">
                            <button id="main-gen-btn" onclick="generateExercise()" class="btn-lumina btn-primary text-white w-full md:min-w-[320px] opacity-50 cursor-not-allowed py-4 md:py-5 text-base md:text-lg rounded-2xl" disabled>
                                <span id="gen-btn-text">Generar Obra Extendida</span>
                                <span id="gen-btn-loader" class="hidden animate-spin text-xl">‚ü≥</span>
                            </button>
                            <p id="api-warning" class="text-[9px] md:text-[10px] text-danger font-bold uppercase tracking-widest hidden italic">‚ö† Configura la API primero</p>
                        </div>
                    </div>

                    <!-- MODAL API CONFIG -->
                    <div id="api-modal-overlay" class="modal-overlay hidden">
                        <div class="bg-white border border-slate-200 p-6 md:p-10 rounded-2xl md:rounded-3xl shadow-2xl w-full max-w-sm md:max-w-md animate-slide-up mx-4">
                            <h3 class="text-xl md:text-2xl font-bold text-slate-900 mb-2 text-center">Gemini API Key</h3>
                            <div class="space-y-4 md:space-y-6">
                                <input type="password" id="api-key-input" placeholder="Pega tu clave aqu√≠..." class="w-full bg-slate-50 border border-slate-200 text-slate-700 p-3 md:p-4 rounded-xl text-xs md:text-sm outline-none focus:ring-4 focus:ring-indigo-100 transition-all">
                                <div class="flex gap-3 pt-2">
                                    <button onclick="toggleApiModal()" class="flex-1 btn-lumina btn-ghost text-[10px]">Cerrar</button>
                                    <button onclick="saveApiKey()" class="flex-1 btn-lumina btn-primary text-[10px]">Guardar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow p-4 md:p-12 overflow-x-auto flex flex-col items-center bg-white relative">
                        <div id="paper-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10 hidden">
                             <div class="flex flex-col items-center gap-3">
                                <div class="animate-spin rounded-full h-10 w-10 md:h-16 md:w-16 border-t-4 border-indigo-500 border-r-transparent"></div>
                                <span class="text-indigo-600 font-bold text-[10px] uppercase tracking-widest">Generando estructura...</span>
                             </div>
                        </div>
                        <div id="paper" class="w-full max-w-4xl"></div>
                    </div>

                    <div class="px-4 md:px-8 py-3 border-t border-slate-100 bg-slate-50/50 flex justify-between items-center text-[8px] md:text-[11px] font-bold text-slate-400 uppercase tracking-widest">
                        <div class="flex space-x-4 md:space-x-12">
                            <div>Comp√°s: <span id="time-sig" class="text-indigo-600 ml-1">--</span></div>
                            <div>Tono: <span id="key-sig" class="text-indigo-600 ml-1">--</span></div>
                        </div>
                        <div class="flex items-center gap-1 opacity-60">
                            <span class="text-indigo-400">‚ö°</span> <span>Long-Play Engine</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let apiKey = ""; 

        // OBRAS RE-ESTRUCTURADAS: Cada l√≠nea de notas debe ir seguida inmediatamente de su w:
        const SONGS = {
            'minuet': { 
                title: "Minueto en Sol Mayor (Bach)", 
                subtitle: "Bach / Barroco - Estructura Completa", 
                tempo: 110, beats: 3, key: "G", time: "3/4", 
                abc: `X:1\nM:3/4\nL:1/8\nQ:1/4=110\nK:G\nV:1 treble\nV:2 bass\n[V:1] !5!d2 !1!G!2!A !3!B!4!c | !5!d2 !1!G2 !1!G2 | !5!e2 !4!c!5!d !3!e!4!f | !5!g2 !1!G2 !1!G2 |\nw: Re Sol La Si Do | Re Sol Sol | Mi Do Re Mi Fa# | Sol Sol Sol |\n[V:1] !4!c2 !5!d!4!c !3!B!2!A | !3!B2 !4!c!3!B !2!A!1!G | !1!F!2!G !3!A!2!B !3!A!1!G | !2!A6 |\nw: Do Re Do Si La | Si Do Si La Sol | Fa# Sol La Si La Sol | La |\n[V:1] !5!d2 !1!G!2!A !3!B!4!c | !5!d2 !1!G2 !1!G2 | !5!e2 !4!c!5!d !3!e!4!f | !5!g2 !1!G2 !1!G2 |\nw: Re Sol La Si Do | Re Sol Sol | Mi Do Re Mi Fa# | Sol Sol Sol |\n[V:1] !4!c2 !5!d!4!c !3!B!2!A | !3!B2 !4!c!3!B !2!A!1!G | !1!A2 !2!B2 !3!A2 | !1!G6 |\nw: Do Re Do Si La | Si Do Si La Sol | La Si La | Sol |\n[V:2] !5!G,2 !3!B,2 !1!D2 | !5!G,4 !5!G,2 | !5!C2 !3!E2 !1!G2 | !5!C4 !5!C2 |\nw: Sol Si Re | Sol Sol | Do Mi Sol | Do Do |\n[V:2] !3!E,4 !3!E,2 | !5!G,4 !5!G,2 | !1!D,4 !1!D,2 | !1!D,6 |\nw: Mi Mi | Sol Sol | Re Re | Re |\n[V:2] !5!G,2 !3!B,2 !1!D2 | !5!G,4 !5!G,2 | !5!C2 !3!E2 !1!G2 | !5!C4 !5!C2 |\nw: Sol Si Re | Sol Sol | Do Mi Sol | Do Do |\n[V:2] !3!E,4 !3!E,2 | !5!G,4 !5!G,2 | !1!D,2 !1!D,2 !5!D,2 | !1!G,,6 |\nw: Mi Mi | Sol Sol | Re Re Re | Sol |` 
            },
            'scale_c': { 
                title: "Escala Do Mayor (Maestro)", 
                subtitle: "T√©cnica - 2 Octavas y Arpegios", 
                tempo: 80, beats: 4, key: "C", time: "4/4", 
                abc: `X:1\nM:4/4\nL:1/4\nQ:1/4=80\nK:C\nV:1 treble\nV:2 bass\n[V:1] !1!C !2!D !3!E !1!F | !2!G !3!A !4!B !5!c | !1!c !2!d !3!e !1!f | !2!g !3!a !4!b !5!c' |\nw: Do Re Mi Fa | Sol La Si Do | Do Re Mi Fa | Sol La Si Do |\n[V:1] !5!c' !4!b !3!a !2!g | !1!f !3!e !2!d !1!c | !5!c !4!B !3!A !2!G | !1!F !3!E !2!D !1!C |\nw: Do Si La Sol | Fa Mi Re Do | Do Si La Sol | Fa Mi Re Do |\n[V:1] !1!C !3!E !5!G !5!c | !1!E !3!G !5!c !5!e | !1!G !3!B !5!d !5!g | !5!c'4 |\nw: Do Mi Sol Do | Mi Sol Do Mi | Sol Si Re Sol | Do |\n[V:2] !5!C, !4!D, !3!E, !2!F, | !1!G, !3!A, !2!B, !1!C | !5!C !4!D !3!E !2!F | !1!G !3!A !2!B !1!c |\nw: Do Re Mi Fa | Sol La Si Do | Do Re Mi Fa | Sol La Si Do |\n[V:2] !1!c !2!B !3!A !1!G | !2!F !3!E !4!D !5!C | !1!C !2!B, !3!A, !1!G, | !2!F, !3!E, !4!D, !5!C, |\nw: Do Si La Sol | Fa Mi Re Do | Do Si La Sol | Fa Mi Re Do |\n[V:2] !5!C,4 | !5!E,4 | !5!G,4 | !1!C,4 |\nw: Do | Mi | Sol | Do |` 
            },
            'ode_joy': { 
                title: "Oda a la Alegr√≠a (Beethoven)", 
                subtitle: "Estructura A-B-A Completa", 
                tempo: 120, beats: 4, key: "G", time: "4/4", 
                abc: `X:1\nM:4/4\nL:1/4\nQ:1/4=120\nK:G\nV:1 treble\nV:2 bass\n[V:1] !3!B !3!B !4!c !5!d | !5!d !4!c !3!B !2!A | !1!G !1!G !2!A !3!B | !3!B>!2!A !2!A2 |\nw: Si Si Do Re | Re Do Si La | Sol Sol La Si | Si La La |\n[V:1] !3!B !3!B !4!c !5!d | !5!d !4!c !3!B !2!A | !1!G !1!G !2!A !3!B | !2!A>!1!G !1!G2 |\nw: Si Si Do Re | Re Do Si La | Sol Sol La Si | La Sol Sol |\n[V:1] !2!A !2!A !3!B !1!G | !2!A !3!B/c/ !3!B !1!G | !2!A !3!B/c/ !3!B !2!A | !1!G !2!A !1!D2 |\nw: La La Si Sol | La Si Do Si Sol | La Si Do Si La | Sol La Re |\n[V:1] !3!B !3!B !4!c !5!d | !5!d !4!c !3!B !2!A | !1!G !1!G !2!A !3!B | !2!A>!1!G !1!G2 |\nw: Si Si Do Re | Re Do Si La | Sol Sol La Si | La Sol Sol |\n[V:2] !1!G,2 !2!B,2 | !1!D2 !1!G,2 | !2!E,2 !3!C2 | !1!D,4 |\nw: Sol Si | Re Sol | Mi Do | Re |\n[V:2] !1!G,2 !2!B,2 | !1!D2 !1!G,2 | !2!E,2 !1!D,2 | !1!G,4 |\nw: Sol Si | Re Sol | Mi Re | Sol |\n[V:2] !1!D,4 | !1!D,4 | !1!D,4 | !1!G,2 !1!D,2 |\nw: Re | Re | Re | Sol Re |\n[V:2] !1!G,2 !2!B,2 | !1!D2 !1!G,2 | !2!E,2 !1!D,2 | !1!G,4 |\nw: Sol Si | Re Sol | Mi Re | Sol |` 
            },
            'vals_1': { 
                title: "Vals No. 1 (Danza)", 
                subtitle: "Desarrollo r√≠tmico en 3/4", 
                tempo: 100, beats: 3, key: "G", time: "3/4", 
                abc: `X:1\nM:3/4\nL:1/4\nQ:1/4=100\nK:G\nV:1 treble\nV:2 bass\n[V:1] !1!G !3!B !5!d | !5!d2 !5!d | !4!c !2!A !4!c | !3!B2 !1!G |\nw: Sol Si Re | Re Re | Do La Do | Si Sol |\n[V:1] !1!G !3!B !5!d | !5!d2 !5!d | !4!c !2!A !4!c | !1!G3 |\nw: Sol Si Re | Re Re | Do La Do | Sol |\n[V:1] !2!A !3!B !4!c | !5!d2 !3!B | !2!A !3!B !4!c | !2!A2 !1!D |\nw: La Si Do | Re Si | La Si Do | La Re |\n[V:1] !1!G !3!B !5!d | !5!g2 !4!f | !3!e !2!d !4!c | !1!G3 |\nw: Sol Si Re | Sol Fa | Mi Re Do | Sol |\n[V:2] !5!G,, [G,B,D] [G,B,D] | !5!G,, [G,B,D] [G,B,D] | !2!F,, [F,A,C] [F,A,C] | !5!G,, [G,B,D] [G,B,D] |\nw: Sol Maj Maj | Sol Maj Maj | Fa Maj Maj | Sol Maj Maj |\n[V:2] !5!G,, [G,B,D] [G,B,D] | !5!G,, [G,B,D] [G,B,D] | !2!F,, [F,A,C] [F,A,C] | !5!G,,3 |\nw: Sol Maj Maj | Sol Maj Maj | Fa Maj Maj | Sol |\n[V:2] !1!D, [F,A,C] [F,A,C] | !5!G, [G,B,D] [G,B,D] | !1!D, [F,A,C] [F,A,C] | !1!D,3 |\nw: Re Maj Maj | Sol Maj Maj | Re Maj Maj | Re |\n[V:2] !5!G,, [G,B,D] [G,B,D] | !5!B,, [G,B,D] [G,B,D] | !1!D, [F,A,C] [F,A,C] | !5!G,,3 |\nw: Sol Maj Maj | Si Maj Maj | Re Maj Maj | Sol |` 
            },
            'brahms_lullaby': { 
                title: "Canci√≥n de Cuna", 
                subtitle: "Johannes Brahms - Versi√≥n Extendida", 
                tempo: 80, beats: 3, key: "C", time: "3/4", 
                abc: `X:1\nM:3/4\nL:1/4\nQ:1/4=80\nK:C\nV:1 treble\nV:2 bass\n[V:1] !3!E E !5!G | !3!E E !5!G | !3!E !5!G !5!c | !4!B2 !2!A |\nw: Mi Mi Sol | Mi Mi Sol | Mi Sol Do | Si La |\n[V:1] !2!D D !4!F | !2!D D !4!F | !2!D !4!F !4!B | !3!A2 !1!G |\nw: Re Re Fa | Re Re Fa | Re Fa Si | La Sol |\n[V:1] !3!E E !5!G | !3!E E !5!G | !3!E !5!G !5!c | !4!B2 !2!A |\nw: Mi Mi Sol | Mi Mi Sol | Mi Sol Do | Si La |\n[V:1] !2!D D !4!F | !3!B2 !4!A | !2!G !1!C !2!D | !1!C3 |\nw: Re Re Fa | Si La | Sol Do Re | Do |\n[V:2] !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] |\nw: Do Maj Maj | Do Maj Maj | Do Maj Maj | Sol Maj Maj |\n[V:2] !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] | !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] | !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] | !5!C,3 |\nw: Sol Maj Maj | Sol Maj Maj | Sol Maj Maj | Do |\n[V:2] !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !5!C, [!3!E,!1!G,] [!3!E,!1!G,] | !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] |\nw: Do Maj Maj | Do Maj Maj | Do Maj Maj | Sol Maj Maj |\n[V:2] !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] | !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] | !1!G,, [!4!D,!2!F,] [!4!D,!2!F,] | !5!C,3 |\nw: Sol Maj Maj | Sol Maj Maj | Sol Maj Maj | Do |` 
            },
            'cancan': { 
                title: "Can-Can (Final Galop)", 
                subtitle: "Offenbach - Alta Energ√≠a", 
                tempo: 130, beats: 4, key: "C", time: "4/4", 
                abc: `X:1\nM:4/4\nL:1/4\nQ:1/4=130\nK:C\nV:1 treble\nV:2 bass\n[V:1] !1!C !1!C !2!D !2!D | !3!E !3!E !4!F !4!F | !5!G !5!G !5!G !5!G | !3!E2 !1!C2 |\nw: Do Do Re Re | Mi Mi Fa Fa | Sol Sol Sol Sol | Mi Do |\n[V:1] !1!C !1!C !2!D !2!D | !3!E !3!E !4!F !4!F | !5!G !2!B !3!d !5!g | !5!c'4 |\nw: Do Do Re Re | Mi Mi Fa Fa | Sol Si Re Sol | Do |\n[V:1] !1!c !1!c !2!d !2!d | !3!e !3!e !4!f !4!f | !5!g !5!g !5!g !5!g | !3!e2 !1!c2 |\nw: Do Do Re Re | Mi Mi Fa Fa | Sol Sol Sol Sol | Mi Do |\n[V:1] !1!c !1!c !2!d !2!d | !3!e !3!e !4!f !4!f | !5!g !2!b !3!d' !5!g' | !5!c'4 |\nw: Do Do Re Re | Mi Mi Fa Fa | Sol Si Re Sol | Do |\n[V:2] !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, |\nw: Do Sol Do Sol | Do Sol Do Sol | Do Sol Do Sol | Do Sol Do Sol |\n[V:2] !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, | !1!G, !2!B, !3!D !1!G | !5!C,4 |\nw: Do Sol Do Sol | Do Sol Do Sol | Sol Si Re Sol | Do |\n[V:2] !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, |\nw: Do Sol Do Sol | Do Sol Do Sol | Do Sol Do Sol | Do Sol Do Sol |\n[V:2] !5!C, !1!G, !5!C, !1!G, | !5!C, !1!G, !5!C, !1!G, | !1!G, !2!B, !3!D !1!G | !5!C,4 |\nw: Do Sol Do Sol | Do Sol Do Sol | Sol Si Re Sol | Do |` 
            }
        };

        const noteNamesMap = { 
            "Do": "C", "Re": "D", "Mi": "E", "Fa": "F", "Sol": "G", "La": "A", "Si": "B" 
        };

        let state = { songId: 'minuet', tempo: 110, fingers: true, cipher: 'lat', isPlaying: false, isMetro: false, audioCtx: null, generatedSong: null, currentOption: null };
        let abcInstance, synthControl, timingCallbacks, metronomeTimer;

        document.addEventListener('DOMContentLoaded', () => {
            loadSong('minuet');
            setupListeners();
        });

        function setupListeners() {
            document.getElementById('song-selector').addEventListener('change', (e) => loadSong(e.target.value));
            document.getElementById('fingering-btn').addEventListener('click', toggleFingers);
            document.getElementById('cipher-btn').addEventListener('click', toggleCipher);
            document.getElementById('play-btn').addEventListener('click', playPiano);
            document.getElementById('stop-btn').addEventListener('click', stopAll);
            document.getElementById('metro-btn').addEventListener('click', toggleMetro);
            document.getElementById('tempo-slider').addEventListener('input', (e) => updateTempo(0, parseInt(e.target.value)));
            window.addEventListener('resize', debounce(() => renderScore(), 250));
        }

        function debounce(func, wait) {
            let timeout;
            return function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, arguments), wait);
            };
        }

        function toggleApiModal() { document.getElementById('api-modal-overlay').classList.toggle('hidden'); }
        function toggleAiGenerator() { document.getElementById('ai-generator-overlay').classList.toggle('hidden'); }

        function saveApiKey() {
            const input = document.getElementById('api-key-input').value;
            if(input) {
                apiKey = input;
                document.getElementById('api-status-icon').className = 'text-amber-500';
                toggleApiModal();
                showNotification("API Guardada.");
            }
        }

        function selectAiOption(option, element) {
            state.currentOption = option;
            document.querySelectorAll('.ai-option-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            const genBtn = document.getElementById('main-gen-btn');
            genBtn.disabled = false; genBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            if(!apiKey) document.getElementById('api-warning').classList.remove('hidden');
        }

        async function callGemini(promptText) {
            if(!apiKey) return null;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) { showNotification("Error IA."); return null; }
        }

        async function generateExercise() {
            if (!state.currentOption || !apiKey) return;
            const btn = document.getElementById('main-gen-btn'), loader = document.getElementById('gen-btn-loader'), 
                  text = document.getElementById('gen-btn-text'), paperLoading = document.getElementById('paper-loading');
            btn.disabled = true; loader.classList.remove('hidden'); text.classList.add('hidden'); paperLoading.classList.remove('hidden');

            let handRule = state.currentOption === 'Mano Izquierda' ? "V:1 clef=bass" : (state.currentOption === 'Mano Derecha' ? "V:1 clef=treble" : "V:1 (derecha) y V:2 clef=bass (izquierda)");

            const prompt = `Genera un ejercicio de piano de LARGA DURACI√ìN (16 compases) en formato ABC bas√°ndote en: "${state.currentOption}".
REGLAS: X:1, T:Ejercicio IA, M:4/4, L:1/4, K:C. ${handRule}. 
CIFRADO CR√çTICO: Divide la m√∫sica en l√≠neas de 4 compases. DESPU√âS DE CADA L√çNEA de notas, pon una l√≠nea 'w:' con los nombres en espa√±ol (Do, Re...). Incluye digitaci√≥n (!1!-!5!). Devuelve SOLO c√≥digo plano.`;

            let abcCode = await callGemini(prompt);
            if (abcCode) {
                abcCode = abcCode.replace(/```[a-z]*\n?/gi, '').replace(/```/g, '').trim();
                state.generatedSong = { title: "Composici√≥n IA", subtitle: `Enfoque: ${state.currentOption}`, tempo: 100, beats: 4, key: "C", time: "4/4", abc: abcCode };
                const timeMatch = abcCode.match(/M:(\d+)\/(\d+)/);
                if (timeMatch) state.generatedSong.beats = parseInt(timeMatch[1]);
                loadSong('generated');
                toggleAiGenerator();
            }
            btn.disabled = false; loader.classList.add('hidden'); text.classList.remove('hidden'); paperLoading.classList.add('hidden');
        }

        function loadSong(id) {
            stopAll();
            let song = (id === 'generated' && state.generatedSong) ? state.generatedSong : SONGS[id];
            state.songId = id;
            document.getElementById('song-meta').innerText = song.subtitle || "Cargando...";
            updateTempo(0, song.tempo);
            document.getElementById('time-sig').innerText = song.time;
            document.getElementById('key-sig').innerText = song.key;
            const beatContainer = document.getElementById('beat-container');
            beatContainer.innerHTML = '';
            for(let i=0; i<song.beats; i++) {
                const dot = document.createElement('div');
                dot.className = `beat-dot`;
                dot.id = `beat-${i+1}`;
                beatContainer.appendChild(dot);
            }
            renderScore();
        }

        function renderScore() {
            let song = state.songId === 'generated' ? state.generatedSong : SONGS[state.songId];
            let abc = song.abc;
            if (abc.includes('Q:')) abc = abc.replace(/Q:1\/4=\d+/, `Q:1/4=${state.tempo}`);
            else abc = abc.replace('K:', `Q:1/4=${state.tempo}\nK:`);
            if(!state.fingers) abc = abc.replace(/![1-5]!/g, "");

            if(state.cipher === 'off') {
                abc = abc.split('\n').filter(l => !l.trim().startsWith('w:')).join('\n');
            } else if (state.cipher === 'ang') {
                abc = abc.split('\n').map(line => {
                    if (line.trim().startsWith('w:')) {
                        let content = line.replace(/^\s*w:\s*/, '');
                        // Mapeo ordenado para no pisar (ej: Sol antes que So)
                        const sortedKeys = Object.keys(noteNamesMap).sort((a,b) => b.length - a.length);
                        sortedKeys.forEach(k => {
                            const regex = new RegExp(k + '(?![a-z])', 'g');
                            content = content.replace(regex, noteNamesMap[k]);
                        });
                        return 'w: ' + content;
                    }
                    return line;
                }).join('\n');
            }

            abcInstance = ABCJS.renderAbc("paper", abc, {
                responsive: 'resize', add_classes: true, staffwidth: 800, scale: 1.1,
                clickListener: (abcElem) => { if (abcElem && abcElem.el_type === "note") showTooltip(window.event, abcElem.pitches[0].pitch); }
            })[0];
        }

        function updateTempo(delta, exact = null) {
            state.tempo = exact ? exact : Math.max(40, Math.min(220, state.tempo + delta));
            document.getElementById('tempo-display').innerText = state.tempo;
            document.getElementById('tempo-slider').value = state.tempo;
            if(state.isPlaying || state.isMetro) { const wasPlaying = state.isPlaying; stopAll(); if(wasPlaying) playPiano(); } else renderScore();
        }

        function initAudio() {
            if (!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (state.audioCtx.state === 'suspended') state.audioCtx.resume();
        }

        async function playPiano() {
            if (state.isPlaying) { stopAll(); return; }
            initAudio(); state.isPlaying = true;
            document.getElementById('play-btn').classList.replace('btn-primary', 'btn-ghost');
            document.getElementById('play-btn').innerHTML = '<span>‚è∏ Pausar</span>';

            if (ABCJS.synth.supportsAudio()) {
                const synth = new ABCJS.synth.CreateSynth();
                let song = state.songId === 'generated' ? state.generatedSong : SONGS[state.songId];
                const audioObj = ABCJS.renderAbc("paper", song.abc.replace(/Q:1\/4=\d+/, `Q:1/4=${state.tempo}`), { responsive: 'resize' })[0];
                timingCallbacks = new ABCJS.TimingCallbacks(audioObj, {
                    qpm: state.tempo,
                    eventCallback: (ev) => {
                        document.querySelectorAll('.abcjs-highlight').forEach(el => el.classList.remove('abcjs-highlight'));
                        if (ev && ev.elements) {
                            ev.elements.forEach(set => set.forEach(el => {
                                el.classList.add('abcjs-highlight');
                                const nid = Array.from(el.classList).find(c => c.startsWith('abcjs-n'));
                                if(nid) document.querySelectorAll(`.${nid}.abcjs-lyric`).forEach(l => l.classList.add('abcjs-highlight'));
                            }));
                        }
                    },
                    beatCallback: (beatNumber) => visualizeBeat((beatNumber % song.beats) + 1)
                });
                await synth.init({ visualObj: audioObj, options: { soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/" } });
                await synth.prime(); synth.start(); timingCallbacks.start(); synthControl = { synth };
            }
        }

        function toggleMetro() {
            if(state.isMetro) { stopAll(); return; }
            stopAll(); initAudio(); state.isMetro = true;
            document.getElementById('metro-btn').classList.add('bg-indigo-500', 'text-white');
            let song = state.songId === 'generated' ? state.generatedSong : SONGS[state.songId], currentBeat = 0, nextTime = state.audioCtx.currentTime;
            function schedule() {
                if(!state.isMetro) return;
                while (nextTime < state.audioCtx.currentTime + 0.1) {
                    playClick(nextTime, currentBeat % song.beats === 0);
                    const b = (currentBeat % song.beats) + 1;
                    setTimeout(() => visualizeBeat(b), (nextTime - state.audioCtx.currentTime) * 1000);
                    nextTime += 60.0 / state.tempo; currentBeat++;
                }
                metronomeTimer = setTimeout(schedule, 25);
            }
            schedule();
        }

        function playClick(time, strong) {
            const osc = state.audioCtx.createOscillator(), gain = state.audioCtx.createGain();
            osc.frequency.value = strong ? 1000 : 600; gain.gain.setValueAtTime(0.2, time); 
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05); osc.connect(gain); 
            gain.connect(state.audioCtx.destination); osc.start(time); osc.stop(time + 0.05);
        }

        function stopAll() {
            state.isPlaying = false; state.isMetro = false;
            if(synthControl) { synthControl.synth.stop(); synthControl = null; }
            if(timingCallbacks) { timingCallbacks.stop(); timingCallbacks = null; }
            if(metronomeTimer) { clearTimeout(metronomeTimer); metronomeTimer = null; }
            const btn = document.getElementById('play-btn');
            btn.classList.replace('btn-ghost', 'btn-primary'); btn.innerHTML = '<span>‚ñ∂ Iniciar Pr√°ctica</span>';
            document.getElementById('metro-btn').classList.remove('bg-indigo-500', 'text-white');
            document.querySelectorAll('.abcjs-highlight').forEach(el => el.classList.remove('abcjs-highlight'));
            document.querySelectorAll('.beat-dot').forEach(el => el.classList.remove('beat-active'));
        }

        function visualizeBeat(n) {
            document.querySelectorAll('.beat-dot').forEach(el => el.classList.remove('beat-active'));
            const dot = document.getElementById(`beat-${n}`);
            if(dot) dot.classList.add('beat-active');
        }

        function toggleFingers() {
            state.fingers = !state.fingers;
            document.getElementById('fingering-status').innerText = state.fingers ? 'ON' : 'OFF';
            document.getElementById('fingering-status').className = state.fingers ? 'bg-indigo-100 text-indigo-600 px-2.5 py-0.5 rounded-full text-[10px] font-bold' : 'bg-slate-200 text-slate-500 px-2.5 py-0.5 rounded-full text-[10px] font-bold';
            renderScore();
        }

        function toggleCipher() {
            const status = document.getElementById('cipher-status');
            if (state.cipher === 'lat') { state.cipher = 'ang'; status.innerText = 'ANG'; status.classList.replace('bg-slate-200', 'bg-indigo-100'); status.classList.replace('text-slate-500', 'text-indigo-600'); }
            else if (state.cipher === 'ang') { state.cipher = 'off'; status.innerText = 'OFF'; status.classList.replace('bg-indigo-100', 'bg-slate-200'); status.classList.replace('text-indigo-600', 'text-slate-500'); }
            else { state.cipher = 'lat'; status.innerText = 'LAT'; }
            renderScore();
        }

        function showTooltip(e, pitch) {
            if(!e) return;
            const tooltip = document.getElementById('note-tooltip');
            tooltip.innerText = state.cipher === 'ang' ? (pitch % 12) : (pitch % 12); // Simplificado
            tooltip.style.display = 'block'; 
            const x = e.pageX || (e.touches ? e.touches[0].pageX : 0);
            const y = e.pageY || (e.touches ? e.touches[0].pageY : 0);
            tooltip.style.left = x + 'px'; tooltip.style.top = y + 'px';
            setTimeout(() => tooltip.style.display = 'none', 1500);
        }

        function showNotification(msg) {
            const box = document.getElementById('notification-box');
            box.innerText = msg; box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html>
