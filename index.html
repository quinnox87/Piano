<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PianoClass: Edición Para Elisa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.2.2/abcjs-basic-min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #F8FAFC; font-family: 'Inter', sans-serif; }
        .abcjs-highlight { fill: #6366F1 !important; stroke: #6366F1 !important; }
        .abcjs-lyric { fill: #94A3B8; font-size: 12px; }
        .abcjs-fingering { fill: #EF4444; font-weight: bold; font-size: 11px; }
        #paper svg { width: 100%; height: auto; }
        .beat-dot { width: 12px; height: 12px; border-radius: 50%; background: #E2E8F0; transition: all 0.1s; }
        .beat-active { background: #6366F1; transform: scale(1.3); box-shadow: 0 0 8px rgba(99, 102, 241, 0.5); }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="mb-8 border-b border-slate-200 pb-6 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900">Für Elise <span class="text-indigo-500">Practice</span></h1>
                <p class="text-slate-500">L. van Beethoven · Nivel Iniciación</p>
            </div>
            <div class="flex gap-2 mb-1" id="beat-indicator">
                <div class="beat-dot" id="dot-1"></div>
                <div class="beat-dot" id="dot-2"></div>
                <div class="beat-dot" id="dot-3"></div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <button id="play-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all mb-4 shadow-lg shadow-indigo-100">
                        ▶ Reproducir
                    </button>
                    <button id="stop-btn" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 rounded-xl transition-all">
                        ⏹ Detener
                    </button>
                    
                    <div class="mt-6">
                        <div class="flex justify-between text-xs font-bold text-slate-400 uppercase mb-2">
                            <span>Tempo</span>
                            <span id="tempo-val">90 BPM</span>
                        </div>
                        <input type="range" id="tempo-slider" min="40" max="140" value="90" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <h3 class="text-indigo-800 text-xs font-bold uppercase mb-2">Consejo Neuro</h3>
                    <p class="text-indigo-700 text-xs leading-relaxed">
                        Divide la pieza en "chunks" de 2 compases. La alternancia Mi-Re# inicial es excelente para la velocidad de procesamiento motriz.
                    </p>
                </div>
            </div>

            <div class="lg:col-span-3 bg-white p-4 md:p-8 rounded-2xl shadow-sm border border-slate-200">
                <div id="paper"></div>
            </div>
        </div>
    </div>

    <script>
        const ABC_DATA = `X:1
T:Für Elise (Main Theme)
M:3/8
L:1/16
Q:1/8=90
K:Am
V:1 treble
!5!e !4!^d | !5!e !4!^d !5!e !2!B !4!d !3!c | !1!A2 z !1!C !2!E !3!A | !2!B2 z !2!E !3!^G !2!B | !3!c2 z !2!E !5!e !4!^d |
w: Mi Re# Mi Re# Mi Si Re Do | La Do Mi La | Si Mi Sol# Si | Do Mi Mi Re# |
V:1
!5!e !4!^d !5!e !2!B !4!d !3!c | !1!A2 z !1!C !2!E !3!A | !2!B2 z !2!E !3!c !2!B | !1!A2 z |]
w: Mi Re# Mi Re# Mi Si Re Do | La Do Mi La | Si Mi Do Si | La |
V:2 bass
z2 | z6 | A,, [E,A,] z | E,, [E,^G,] z | A,, [E,A,] z |
V:2
z6 | A,, [E,A,] z | E,, [E,^G,] z | A,, [E,A,] z |]`;

        let visualObj, synthControl, timingCallbacks;
        let audioCtx = null;

        function render() {
            const tempo = document.getElementById('tempo-slider').value;
            visualObj = ABCJS.renderAbc("paper", ABC_DATA.replace('Q:1/8=90', `Q:1/8=${tempo}`), {
                responsive: 'resize',
                add_classes: true,
                paddingright: 0,
                paddingleft: 0
            })[0];
        }

        async function play() {
            if (synthControl) stop();
            if (!audioCtx) audioCtx = new AudioContext();
            
            const tempo = document.getElementById('tempo-slider').value;
            const synth = new ABCJS.synth.CreateSynth();
            
            await synth.init({
                visualObj: visualObj,
                options: { soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/" }
            });

            timingCallbacks = new ABCJS.TimingCallbacks(visualObj, {
                qpm: tempo / 2,
                eventCallback: (ev) => {
                    document.querySelectorAll('.abcjs-highlight').forEach(n => n.classList.remove('abcjs-highlight'));
                    if (ev && ev.elements) {
                        ev.elements.forEach(set => set.forEach(el => el.classList.add('abcjs-highlight')));
                    }
                },
                beatCallback: (beat) => {
                    const b = (beat % 3) + 1;
                    document.querySelectorAll('.beat-dot').forEach(d => d.classList.remove('beat-active'));
                    document.getElementById(`dot-${b}`).classList.add('beat-active');
                }
            });

            await synth.prime();
            synth.start();
            timingCallbacks.start();
            synthControl = synth;
            document.getElementById('play-btn').innerText = "⏸ Pausar";
        }

        function stop() {
            if (synthControl) synthControl.stop();
            if (timingCallbacks) timingCallbacks.stop();
            synthControl = null;
            document.getElementById('play-btn').innerText = "▶ Reproducir";
            document.querySelectorAll('.abcjs-highlight').forEach(n => n.classList.remove('abcjs-highlight'));
        }

        document.getElementById('play-btn').onclick = () => synthControl ? stop() : play();
        document.getElementById('stop-btn').onclick = stop;
        document.getElementById('tempo-slider').oninput = (e) => {
            document.getElementById('tempo-val').innerText = `${e.target.value} BPM`;
            render();
        };

        window.onload = render;
    </script>
</body>
</html>
